---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: Climatic Trend Impact on Alaskan Stream Discharge
subtitle: https://github.com/wgrimshaw/Alaska_DBPs.git
author: Gaby Garcia, Walker Grimshaw, Tristen Townsend, Yixin Wen
abstract: "Experimental overview. This section should be no longer than 250 words."
fontsize: 12pt
mainfont: Times New Roman
---

<Information in these brackets are used for annotating the RMarkdown file. They will not appear in the final version of the PDF document>

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

<Setup the global options for the R chunks in your document>

<Note: set up autoreferencing for figures and tables in your document>

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE)
# Set your working directory

# Load your packages
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(tseries)

theme_set(theme_bw())
```


# Research Question and Rationale

<Paragraph detailing the rationale for your analysis. What is the significant application and/or interest in this topic? Connect to environmental topic(s)/challenge(s).>

## Background

<Paragraph detailing your research question(s) and goals. What do you want to find out? Include a sentence (or a few) on the dataset you are using to answer this question - just enough to give your reader an idea of where you are going with the analysis.>

## Research Question

\newpage

# Dataset Information

<Information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the README file for the dataset but formatted in a way that is more narrative.>

## Discharge

Discharge data were collected from NWIS using the Data Retrieval package. The state of Alaska was divided into 10 bins of equal latitude, and daily discharge data was downloaded for the site in each latitude bin with the greatest number of samples. This dataset includes the site location, daily discharge, and county of the site, among other variables not used in the analysis.

## Temperature and Precipitation

Temperature and precipitation data were downloaded from the National Oceanic and Atmospheric Administration (NOAA) Climate Data Online web portal. As discharge stations do not collect data on temperature and precipitation, the climate data for each latitude bin were downloaded from a station in the same county as each selected discharge station. In each county, daily precipitation, maximum temperature, and minimum temperature, data were downloaded from one station. The criteria for station selection include data extending to the current date, beginning at the earliest date, with at least 80% data coverage. This dataset also includes site location.

<Add a table that summarizes your data structure. This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.>

\newpage

# Exploratory Data Analysis and Wrangling

<Include R chunks for 5+ lines of summary code (display code and output), 3+ exploratory graphs (display graphs only), and any wrangling you do to your dataset(s).> 

```{r Main Wrangling}

```

```{r Temperature Graph, echo=FALSE, fig.cap= "Daily maximum temperature for the period of record of each latitude bin. There are no obvious trends, and the period of record differs substantially for each site."}
## create plot of temperature over time for all 10 latitude bins
ggplot(Alaska_Data, aes(x = DATE, y = TMAX)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~Bin, nrow = 3, ncol = 3) +
  labs(y = "Maximum Daily Temperature (F)", x = "Date")
```


# Full Precipitation Period of Record over Time, divided by Bin 
```{r, fig.width=10, fig.height=6}

AlaskaTempPrecipDischarge<-read.csv("AlaskaTempPrecipDischarge.csv")
AlaskaPrecipOnly<-select(AlaskaTempPrecipDischarge, .data$DATE, .data$PRCP, .data$Bin)
newdata<-na.omit(AlaskaPrecipOnly)

PrecipBoxplot<-ggplot(newdata, aes(x = DATE, y = PRCP, color = Bin))  +
  geom_point(alpha=0.5, size=2) +
labs(title="Full Precipitation Period of Record Measured over Time by Bin", x="Sample Year",
       y="Precipitation (inches)")+ 
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("5 years"))+
  scale_fill_manual(guide=guide_legend(keyheight=unit(4, units="mm")))+
  gabytheme
print(PrecipBoxplot)
```



```{r Discharge, plot discharge over time for 10 bins}
AlaskaTempPrecipDischarge <- read_csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")
# transform bin into factor
AlaskaTempPrecipDischarge$Bin <- as.factor(AlaskaTempPrecipDischarge$Bin)
#Extract date and discharge data
AlaskaDischarge <- AlaskaTempPrecipDischarge%>%
  select("DATE", "Bin","STATION","NAME", "site_no", "Discharge")
#drop na
AlaskaDischarge%>%drop_na()
# plot discharge over time for 10 latitude bins
discharge_plot <- ggplot(AlaskaDischarge,aes(x = DATE, y = Discharge))+
  geom_line()+
  facet_wrap(~Bin, nrow = 3, ncol = 3)+
  labs(x = "Date", y =expression("Discharge (ft"^3*"/s)"))
print(discharge_plot)
```

```{r Snowmelt Change}

#Load the data
AlaskaTempPrecipDischarge <- read.csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")

#Convert DATE column to class 'Date'
AlaskaTempPrecipDischarge$DATE <- ymd(Snowmelt.Discharge$DATE)

#Add date columns
Snowmelt.Discharge <- AlaskaTempPrecipDischarge %>% mutate(
                        YEAR = year(DATE), 
                        MONTH = month(DATE), 
                        DAY = day(DATE), 
                        WEEK = week(DATE), 
                        DOY = yday(DATE))

#Filter for weeks 1-30 to deal with less Snowmelt.Discharge
Snowmelt.Discharge.spring <- Snowmelt.Discharge %>% filter(WEEK < 30)

#Dataframes for each bin
#Filter for only needed columns and bin
bin1 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 1)

bin2 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 2)

bin3 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 3)

bin4 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 4)

bin5 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 5)

bin6 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 6)

bin7 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 7)

bin8 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 8)

bin9 <- Snowmelt.Discharge.spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>% filter(Bin == 9)


Snowmelt.Discharge.spring.median <- Snowmelt.Discharge.spring %>% group_by(Bin, DOY) %>%
  mutate(Dis.Med = median(Discharge))
  
dis.doy.med <- ggplot(Snowmelt.Discharge.spring.median) +
  geom_line(aes(x = DOY, y = Dis.Med, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Median Discharge", color = "Latitude Bin") +
  scale_color_viridis_d() +
  theme(legend.position = "top")
print(dis.doy.med)

```


<Include text sections to accompany these R chunks to explain the reasoning behind your workflow, and the rationale for your approach.>


\newpage

# Analysis
<Include R chunks for 3+ statistical tests (display code and output) and 3+ final visualization graphs (display graphs only).>

## Long-term Temperature and Discharge Trends

A seasonal Mann-Kendall test was used to determine if there was a long-term trend in maximum temperature and stream discharge for each latitude.

A seasonal Sen's Slope quantifies the magnitude of the temperature and discharge trends.

```{r Discharge}
# Time series for Bin 6
AlaskaDischagre_6.Monthly <- AlaskaDischarge_6%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year,Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischagre_6_ts.Monthly <- ts(AlaskaDischagre_6.Monthly[[3]], frequency = 12)

AlaskaDischagre_6_trend.Monthly <-smk.test(AlaskaDischagre_6_ts.Monthly) 
AlaskaDischagre_6_trend.Monthly
summary(AlaskaDischagre_6_trend.Monthly)

# test if the data is stationary
adf.test(AlaskaDischagre_6_ts.Monthly, alternative = "stationary")
# since the p-value is 0.01 < 0.05, the data is stationary

#run the arima function and search for best fit
auto.arima(AlaskaDischagre_6_ts.Monthly, trace = TRUE)

# create an object that defines the best fit model
fit <- arima(AlaskaDischagre_6_ts.Monthly, c(1, 0, 0),seasonal = list(order = c(1, 1, 0), period = 12)) 

# make a prediction into the future
AlaskaDischagre_6_prediction <- predict(fit, n.ahead = 10*12)

# plot future predictions
ts.plot(AlaskaDischagre_6_ts.Monthly, AlaskaDischagre_6_prediction$pred, lty = c(1, 3))
```

## Predictability of snowmelt

Analy

Is there a change over time of the period when snow melts? Perhaps be looking at the date of the greatest increase in discharge.




<Include text sections to accompany these R chunks to explain the reasoning behind your workflow, rationale for your approach, and the justification of meeting or failing to meet assumptions of tests.>


\newpage

# Summary and Conclusions
<Summarize your major findings from your analyses. What conclusions do you draw from your findings? Make sure to apply this to a broader application for the research question you have answered.>



