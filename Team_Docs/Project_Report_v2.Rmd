---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Climatic Trend Impact on Alaskan Stream Discharge"
subtitle: "https://github.com/wgrimshaw/Alaska_DBPs.git"
author: "Gaby Garcia, Walker Grimshaw, Tristen Townsend, Yixin Wen"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: inline
---

\newpage

<**General Guidelines**>
<1. Write in scientific style> 
<2. [Global options for R chunks](https://rmarkdown.rstudio.com/lesson-3.html) should be set so that only relevant output is displayed>
<3. Make sure your final knitted PDF looks professional. Format tables appropriately, size figures appropriately, make sure bulleted and numbered lists appear as such, avoid awkwardly placed page breaks, etc.>

```{r setup, include=FALSE}
## Global options to not print warning or messages
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
# Set your working directory

# Load your packages
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(tseries)
library(sf)
library(maps)
library(dataRetrieval)
library(viridis)
library(ggplot2)
library(sf)
library(ggspatial)
library(cowplot)
#library(kableExtra)


# Set your ggplot theme
theme_set(theme_bw())

# Load your datasets

AlaskaTempPrecipDischarge <- 
  read.csv("../DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")

```


# Rationale and Research Questions

<Write 1-2 paragraph(s) detailing the rationale for your study. This should include both the context of the topic as well as a rationale for your choice of dataset (reason for location, variables, etc.) A few citations should be included to give context for your topic. You may choose to configure autoreferencing for your citations or add these manually.>


## Background

The climate is changing, in large part due to anthropogenic carbon emissions. These changes have different magnitudes around the world and local impacts of climate change vary as well. Specifically, climate change is already having greater impacts near the poles than many other parts of the globe, a process known as polar amplification or arctic amplification (Serreze et al 2009). Understanding how climate change is affecting discharge, especially in Alaska, has implications for water management, ecological processes, and the larger global system (if we consider ice-albedo feedback). Many communities rely on a given amount of water from snowmelt to arrive at certain times of the year, so a shift in the quantity or timing could drastically affect downstream users and water managers. Additionally, changing the amount of flow in rivers could affect sensitive biological communities. Furthermore, changes in temperature that result in glacial or permafrost melting could reduce the amount of reflective land cover, thus disrupting larger climate systems.

<At the end of your rationale, introduce a numbered list of your questions (or an overarching question and sub-questions). Each question should be accompanied by one or more working hypotheses, inserted beneath each question.>

## Research Question

To what degree does climate change affect discharge in Alaskan streams and rivers?

This guiding question encompasses other questions we seek to answer through statistical analyses. If climate change is causing average temperatures to increase, and the magnitude of the increase is greater at higher latitudes, then higher latitude streams should demonstrate greater changes in timing and magnitude of peak flows. This study first seeks to examine if the magnitude of temperature changes increase with increasing latitude in Alaska. By analyzing historical streamflow records, we will investigate whether the magnitude of maximum daily temperature change causes a proportional change in the magnitude and timing of peak streamflow. 

Another aspect of climate change's impacts on streamflow is the potential of melting permafrost or glaciers. This analysis uses cumulative annual streamflow and cumulative annual precipitation to determine if interannual snowpack is melting with increasing average temperatures. If so, we expect the difference between annual precipitation and annual streamflow to increase over time.

\newpage

# Dataset Information

<Provide information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the metadata file for the dataset but formatted in a way that is more narrative.>

## Discharge

Discharge data were collected from NWIS using the Data Retrieval package. The state of Alaska was divided into 10 bins of equal latitude, and daily discharge data was downloaded for the site in each latitude bin with the greatest number of samples. This dataset includes the site location, daily discharge, and county of the site, among other variables not used in the analysis.

## Temperature and Precipitation

Temperature and precipitation data were downloaded from the National Oceanic and Atmospheric Administration (NOAA) Climate Data Online web portal. As discharge stations do not collect data on temperature and precipitation, the climate data for each latitude bin were downloaded from a station in the same county as each selected discharge station. In each county, daily precipitation, maximum temperature, and minimum temperature, data were downloaded from one station. The criteria for station selection include data extending to the current date, beginning at the earliest date, with at least 80% data coverage. This dataset also includes site location.


\newpage

# Data Wrangling

<Add a table that summarizes your data structure (variables, units, ranges and/or central tendencies, data source if multiple are used, etc.). This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.>

| Variable | Units (if known) | Type of Variable | Hypothesis | 
|------:|:-----|---------|:------:|
| Discharge | Cubic feet per second | Response | 1a, 1b, 1c |
| Site Number | Latitude/Longitude | Predictor | 1a |
| Date Time | Year/Month/Day | Predictor | 1c |
| Date of First Snowmelt | Year/Month/Day | Predictor | 1a, 1b, 1c |
| Air Temperature | Celsius | Predictor | 1b |
| Precipitation | Millimeters | Predictor | 1a, 1c |
| HUC 8 Watershed Size | Square Meters | Predictor | 1a, 1b | 
| Permafrost Melt | Qualitative | Predictor | 1b | 
| Glacial Coverage/Melting | Qualitative | Predictor | 1b |

# Data Wrangling Methods
<Describe how your team wrangled your dataset in a format similar to a methods section of a journal article.>

### Importing, Cleaning, and Addressing Date Issues

The state of Alaska was divided into 10 bins of equal latitude. Precipitation and temperature data for 10 Alaskan NOAA stations-one inside each latitude bin-was obtained from NOAA's Climate Data Online web portal, and discharge data was retrieved from NWIS's Data Retrieval package using one site in each latitude bin with the greatest number of samples. All discharge data resided in one CSV entitled NWIS_Discharge. All raw CSVs were imported into our Raw Data folder within our project repository on Github, and imported into R using the read.csv function. 

Each of the 10 NOAA stations classified by latitude bin had a unique CSV that was cleaned prior to joining. Ancillary columns from each of the 10 dataframes were removed in order to ensure that each CSV had the same columns in the same order. In order to address date-time issues in the NOAA CSVs for Bin 1 and Bin 5, the as.DATE function was used to change the "DATE" column fron a factor to a date, in the format month/day/year. Next, we changed the format of the "DATE" column to a two digit year, a two digit month, and the two digit day. A function was then written to create early dates that had been misrepresented as years after 2019. Then, the DATE column was inserted into the function written above for each row of the DATE column. Finally, the as.DATE function was used to convert the DATE column into a 4 digit year, a two digit month, and 2 digit day format, our preferred format. 

### Joining Data
After all 10 NOAA dataframes containing precipitation and temperature data were cleaned, they were all joined by row using the rbind function into a new CSV entitiled "TempPrecip". Next, the "site_no" column in the NWIS_Discharge dataframe was converted into a factor using the as.factor function. The revalue function within the "plyr" package was then used to create a new "Bin" column renaming the USGS Station Numbers in the "site_no" column by their bin number. The "Date" column in the Discharge dataframe was renamed to "DATE" so that it matched the "DATE" column in the "TempPrecip" dataframe. Finally, the merge function was used to join the "TempPrecip" and "NWIS_Discharge" dataframes by "DATE" and "Bin" into a new CSV entitled "AlaskaTempPrecipDischarge", and cleaned for clarity. 

# Exploratory Analysis 

<Insert exploratory visualizations of your dataset. This may include, but is not limited to, graphs illustrating the distributions of variables of interest and/or maps of the spatial context of your dataset. Format your R chunks so that graphs are displayed but code is not displayed. Accompany these graphs with text sections that describe the visualizations and provide context for further analyses.>

<Each figure should be accompanied by a caption, and each figure should be referenced within the text>

# Snowmelt Data Wrangling
```{r Snowmelt Exploratory Data Wrangling, echo=FALSE}
 
#Convert DATE column to class 'Date'
AlaskaTempPrecipDischarge$DATE <- ymd(AlaskaTempPrecipDischarge$DATE)

#Add date columns
Snowmelt.Discharge <- AlaskaTempPrecipDischarge %>% mutate(YEAR = year(DATE), MONTH = month(DATE), 
                        DAY = day(DATE), WEEK = week(DATE), 
                        DOY = yday(DATE))

Snowmelt.Discharge.Spring <- Snowmelt.Discharge %>% filter(WEEK < 30)

Snowmelt.Discharge.Bin6 <- Snowmelt.Discharge.Spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>%
  filter(Bin == 6)

#Plot mean discharge for each DOY through time by bin
Snowmelt.Discharge.Mean <- Snowmelt.Discharge.Spring %>% group_by(as.factor(Bin), as.factor(DOY)) %>%
  mutate(Dis.Mean = mean(Discharge))
```


# Snowmelt Graph 1
```{r Snowmelt Day of Year Exploratory Graph 1, fig.cap= c("Day of Year vs. Mean Discharge. This figure shows mean discharge across all nine latitude bins for each day of the year. This graph served to illustrate variation across sites as to when first day of snowmelt and peak snowmelt would occur.")}
dis.doy.mean <- ggplot(Snowmelt.Discharge.Mean) +
  geom_line(aes(x = DOY, y = Dis.Mean, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Mean Discharge", color = "Latitude Bin") +
  scale_color_viridis_d() +
  theme(legend.position = "top") +
  labs(x = "Day of Year", y = "Mean Discharge, cfs")
print(dis.doy.mean)
```

# Snowmelt Graph 2
```{r Snowmelt Day of Year Exploratory Graph 2, fig.cap= c("Day of Year vs. Discharge. This figure shows how discharge changes with day of year across the period of record for Bin 6. This provided a visual cue as to whether snowmelt was occuring earlier and during what time of the year the shift was occuring.")}
dis.doy.6 <- ggplot(Snowmelt.Discharge.Bin6) +
  geom_line(aes(x = DOY, y = Discharge, color = YEAR)) +
  labs(x = "Day of Year", y = "Discharge, cfs", color = "Year") +
  scale_color_viridis_c() +
  theme(legend.position = "right")
print(dis.doy.6)
```

# Snowmelt Graph 3 
```{r Snowmelt Day of Year Exploratory Graph 3, fig.cap= c("Day of Year vs Discharge. This figure shows how discharge changes with day of year across the every ten years across the period of record for fifty years. This provided a visual cue as to whether snowmelt was occuring earlier and during what time of the year the shift was occuring.")}
Snowmelt.Discharge.Bin6.10Year <- Snowmelt.Discharge.Bin6 %>% 
  filter(YEAR == 1969 | YEAR == 1979 | YEAR == 1989 | YEAR == 1999 | YEAR == 2009 | YEAR == 2019)

dis.doy.6.10 <- ggplot(Snowmelt.Discharge.Bin6.10Year) +
  geom_line(aes(x = DOY, y = Discharge, color = as.factor((YEAR)))) +
  labs(x = "Day of Year", y = "Discharge, cfs", color = "Year") +
  scale_color_viridis_d() +
  theme(legend.position = "right") +
  guides(color = guide_legend(reverse=TRUE))
print(dis.doy.6.10)
```


# Precipitation Data Wrangling
```{r Precipitation Exploratory Data Wrangling}
### Create Precipitation only Dataframe with Bins included
AlaskaPrecipOnly<-select(AlaskaTempPrecipDischarge, .data$DATE, .data$PRCP, .data$Bin)

### Check number of Precipitation NA's and remove them
newdata<-AlaskaPrecipOnly

### Ensure Date is a date object and not a factor
newdata$DATE<-as.Date(newdata$DATE)

### Ensure Bin is a factor and not an integer
newdata$Bin <- as.factor(newdata$Bin)

# Subset the Data by Bin
Bin1Precip<-filter(newdata, Bin== 1)
Bin2Precip<-filter(newdata, Bin== 2)
Bin3Precip<-filter(newdata, Bin == 3)
Bin4Precip<-filter(newdata, Bin == 4)
Bin5Precip<-filter(newdata, Bin == 5)
Bin6Precip<-filter(newdata, Bin == 6)
Bin7Precip<-filter(newdata, Bin == 7)
Bin8Precip<-filter(newdata, Bin == 8)
Bin9Precip<-filter(newdata, Bin == 9)

### Ensure Date is a date object and not a factor
 newdata$DATE<-as.Date(newdata$DATE)
 
### Ensure Bin is a factor and not an integer
 newdata$Bin <- as.factor(newdata$Bin)
 
### Add Day of Year, Year, Week,and Month Column
newdata <-mutate(newdata, DOY = yday(DATE), Year=year(DATE), Month=month(DATE), WEEK = week(DATE))

# Subset the Data by Bin
Bin1Precip<-filter(newdata, Bin== 1)
Bin2Precip<-filter(newdata, Bin== 2)
Bin3Precip<-filter(newdata, Bin == 3)
Bin4Precip<-filter(newdata, Bin == 4)
Bin5Precip<-filter(newdata, Bin == 5)
Bin6Precip<-filter(newdata, Bin == 6)
Bin7Precip<-filter(newdata, Bin == 7)
Bin8Precip<-filter(newdata, Bin == 8)
Bin9Precip<-filter(newdata, Bin == 9)

### Set personal theme
gabytheme <- theme_bw(base_size = 17) + 
  theme(plot.title=element_text(face="bold", size="26", color="IndianRed3", hjust=0.5),
        axis.title=element_text(size=22, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"),
legend.key.size=unit(1, "cm"))

```


## Scatterplot of Full Precipitation Period of Record Colored by Bin
```{r Precipitation Exploratory Graph 1, fig.cap= c("Precipitation Measured Over the Entire Period of Record by Bin. This figure shows the general pattern of precipitation changes over time, differentiated by the latitude bin (color). Bin 3 has the most sample points for the entire precipitation period of record. Bin 3's precipitation range has the greatest magnitude compared to the other bins."),fig.width=10, fig.height=6}
 PrecipScatterplot<-ggplot(newdata, aes(x = DATE, y = PRCP, color = Bin))  +
   geom_point(alpha=0.3, size=2) +
 labs( x="Year",
        y="Precipitation (inches)")+
  theme(legend.position="top")+
   gabytheme
 print(PrecipScatterplot)
```


### Group Precip Data by Bin and DOY, create Mean Precip column, and filter weeks to only include the spring
```{r}
Precip.Mean.Spring<-newdata%>%
  group_by(as.factor(Bin),as.factor(DOY))%>%
mutate(MeanPRCP=mean(PRCP))%>%
 filter(WEEK < 30)

### Filter for Bin 6            
 Precip.Mean.Bin6 <- Precip.Mean.Spring %>% 
   filter(Bin == 6)
```


# GRAPH 1
```{r, fig.cap= c("Day of Year vs. Mean Precipitation. This figure shows mean precipitation across all nine latitude bins for each day of the year up until Day 200. This graph served to illustrate precipitation variation across sites. Bin 1 has the greatest spread of mean precipitation."), fig.width=12, fig.height=7}
 PrecipMeanSpringPlot<- ggplot(Precip.Mean.Spring) +
   geom_line(aes(x = DOY, y = MeanPRCP, color = Bin)) +
   labs(x = "Day of Year", y = "Mean Precipitation (inches)", color = "Latitude Bin") +
scale_colour_manual(values = c("#00CED1", "#000000", "#FFFF00", "#FF8C00", "#9400D3", "#FF0000", "#228B22", "#FF00FF", "#CD5C5C"))+

  theme(legend.position = "top")+
  gabytheme
 print(PrecipMeanSpringPlot)
 
```


# GRAPH 2
```{r, fig.cap= c("Day of Year vs. Precipitation. This figure shows how precipitation changes with day of year across the period of record for Bin 6."), fig.width=7,fig.height=5}
 PrecipSpringBin6Plot<- ggplot(Precip.Mean.Bin6) +
   geom_line(aes(x = DOY, y = PRCP, color = Year)) +
   labs(x = "Day of Year", y = "Precipitation (inches)", color = "Year") +
scale_color_viridis_c()+
  gabytheme
 print(PrecipSpringBin6Plot)
```

# Exploratory Precipitation Mapping 
```{r Exploratory Precipitation Mapping Data Wrangling, warning=FALSE, message=FALSE}
# Convert the Alaska dataset to a spatially enabled "sf" data frame
AlaskaTempPrecipDischarge_sf<- st_as_sf(AlaskaTempPrecipDischarge,coords = c('LONGITUDE','LATITUDE'),crs=4326)

# Load in US Census Bureau Cartographic Boundary Shapefiles and Filter for Alaska Only
setwd("~/Desktop/Environmental Data Analytics/Environmental_Data_Analytics/Data/Spatial")
State_sf<- st_read('cb_2018_us_state_20m.shp') 
Alaska_sf<-filter(State_sf, NAME == 'Alaska')

# Create summary dataframe with only NOAA site locations

## NOAA site locations
NOAA_sites <- c("USC00500464", "USC00502107", "USW00025325", "USW00025624",
                "USW00025704", "USW00026451", "USW00026510", "USW00026615",
                "USW00027502", "USW00027502")
NOAA_Lat <- c(58.3814, 64.8603,	55.35, 55.2207,
              51.88333, 61.169, 62.9574, 60.785,
              71.2834, 71.2834)
NOAA_Lon <- c(-134.645, -147.8484, -131.65, -162.7324,
              -176.65, -150.0278, -155.6103, -161.8293,
              -156.7815, -156.7815)

## Combine and add bin number by sorting by latitude
NOAA_site_data <- data.frame(cbind(NOAA_sites, NOAA_Lat, NOAA_Lon)) %>%
  arrange(NOAA_Lat) %>%
  mutate(Bin = c(1,2,3,4,5,6,7,8,9, 10),
         NOAA_Lat = as.numeric(as.character(NOAA_Lat)),
         NOAA_Lon = as.numeric(as.character(NOAA_Lon)))

NOAA_sf <- st_as_sf(NOAA_site_data, coords = c("NOAA_Lon", "NOAA_Lat"),
                         crs = 4326)

## Convert all SF Layers to UTM Projection 
NOAA_sf_utm  <- st_transform(NOAA_sf, c=32609)
Alaska_sf_utm <-st_transform(Alaska_sf,c=32609)

# Create Discharge Sites Dataframe in NAD83
## discharge lat and lon in NAD83
discharge_sites <- readNWISsite(c("15052500", "15072000","15276000", "15297610",
                                "15297680", "15304000", "15453500", "15514000",
                                "15896000", "15908000")) %>%
  select(site_no, dec_lat_va, dec_long_va) %>%
  arrange(dec_lat_va) %>%
  mutate(Bin = c(1,2,3,4,5,6,7,8,9,10)) %>%
  rename(discharge_site = site_no, discharge_lat = dec_lat_va,
         discharge_long = dec_long_va) %>%
  mutate(discharge_lat = as.numeric(as.character(discharge_lat)),
         discharge_long = as.numeric(as.character(discharge_long)))


```

# Create Alaska Temp Precip Discharge Summary using Summarize function
```{r Exploratory Precipitation Mapping}
### Convert Bin Column to a factor
AlaskaTempPrecipDischarge$Bin<-as.factor(AlaskaTempPrecipDischarge$Bin)

## Create Summary
AlaskaMeanPrecipDischargeSummary<-AlaskaTempPrecipDischarge%>%
  group_by(Bin)%>%
  summarize(Lat_Mean=mean(LATITUDE),
            Long_Mean=mean(LONGITUDE),
            Mean_PRCP=mean(PRCP, na.rm=TRUE),
            Mean_Discharge=mean(Discharge, na.rm=TRUE),
            Mean_Max_Temp=mean(TMAX, na.rm=TRUE),
            Mean_Min_Temp=mean(TMIN, na.rm=TRUE))
            

### Convert AlaskaMeanPrecipDischarge Summary to a spatially enabled SF dataframe
AlaskaMeanPrecipDischargeSummary_sf<- st_as_sf(AlaskaMeanPrecipDischargeSummary,coords = c('Long_Mean','Lat_Mean'),crs=4326)

### Transform SF Data to UTM Zone 9N Projection for Alaska
AlaskaMeanPrecipDischargeSummary_utm<- st_transform(AlaskaMeanPrecipDischargeSummary_sf, c=32609)

# Join Discharge Sites dataframe to AlaskaMeanPrecipDischarge Summary
DischargeComplete<- AlaskaMeanPrecipDischargeSummary %>%
  merge(discharge_sites, by ='Bin')

## Convert DischargeComplete DF to a Spatial Features DF
DischargeComplete_sf<- st_as_sf(DischargeComplete,
                              coords = c("discharge_long", "discharge_lat"),
                              crs = 4326)

### Convert SF Dataframe to NAD 83 Zone 9N Projection 
DischargeComplete_utm<- st_transform(DischargeComplete_sf, c=32609)
```


# NOAA Site Locations Map
```{r, fig.cap= c("Map of NOAA Site Locations in Alaska"), warning=FALSE, message=FALSE}
ggplot() +
  geom_sf(data = Alaska_sf_utm, color = "black") +
  geom_sf(data = NOAA_sf_utm, color = "red")+
  annotate(geom = "text", x = -2646393.71741443, y = 6892347.12778545, label = "Site 1", 
    fontface = "bold", color = "black", size = 3)+
    annotate(geom = "text", x = -1596240.56340557, y = 6651448.13349785, label = "Site 2", 
    fontface = "bold", color = "black", size = 3)+
  annotate(geom = "text", x = 331983.335557192, y = 6136937.49851558, label = "Site 3", 
    fontface = "bold", color = "black", size = 3)+
    annotate(geom = "text", x = 170124.757452562, y = 6485029.32907615, label = "Site 4", 
    fontface = "bold", color = "black", size = 3)+
    annotate(geom = "text", x = -1232606.01673571, y =7190206.5729903, label = "Site 5", 
    fontface = "bold", color = "black", size = 3)+
      annotate(geom = "text", x = -617281.853478057, y =6964221.42966571, label = "Site 6", 
    fontface = "bold", color = "black", size = 3)+
    annotate(geom = "text", x = -820303.075649912, y =7261018.14280173, label = "Site 7", 
    fontface = "bold", color = "black", size = 3)+
     annotate(geom = "text", x = -383013.947088387, y =7326000.84850158, label = "Site 8", 
    fontface = "bold", color = "black", size = 3)+
     annotate(geom = "text", x = -463677.067943308, y =8135627.27551388, label = "Site 9", 
    fontface = "bold", color = "black", size = 3)+
  gabytheme
```


# Mean Precipitation Map
```{r fig.cap=c("Map of Mean Precipitation across Alaska by Bin. This map depicts Bin 3 as having the highest mean precipitation across the state, with the lowest mean precipitation falling in northernmost Bin 9."), fig.height=5, fig.width=9}
AlaskaPrecipMap<-ggplot(axes = FALSE) +
  geom_sf(data = Alaska_sf_utm, fill="white", color="black") +
  geom_sf(data = AlaskaMeanPrecipDischargeSummary_utm, aes(color=Mean_PRCP), size=5)  +
  
  
  labs(color="Mean Precipitation (inches)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme

 print(AlaskaPrecipMap)
```
\newpage

# Mean Discharge Map
```{r,fig.cap= c("Map of Mean Discharge across Alaska by Bin. This map depicts Bin 8 as having the highest mean discharge value of 121266.11 cfs. Bin 1 has the lowest mean discharge value of 4.69 cfs."), fig.height=5, fig.width=9}
gabytheme2 <- theme_bw(base_size = 17) + 
  theme(plot.title=element_text(face="bold", size="26", color="IndianRed3", hjust=0.5),
        axis.title=element_text(size=22, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"),
legend.key.size=unit(2, "cm"))

AlaskaDischargeMap<-ggplot(axes = TRUE) +
  geom_sf(data = Alaska_sf_utm, fill="white") +
  geom_sf(data = DischargeComplete_utm, aes(color=Mean_Discharge), size=5)  +
  labs(color="Mean Discharge (cubic feet/s)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme2
  
 print(AlaskaDischargeMap)
```
\newpage


```{r fig.cap=c("Map of Mean Maximum Temperature across Alaska by Bin. This figure depicts Bin 3 as having the highest mean maximum temperature value of 51.97 degrees Fahrenheit."), fig.height=5, fig.width=9}
AlaskaTemperatureMap<-ggplot(axes = TRUE) +
  geom_sf(data = Alaska_sf_utm, fill="white") +
  geom_sf(data = AlaskaMeanPrecipDischargeSummary_utm, aes(color=Mean_Max_Temp), size=5)  +
  labs(color="Mean Max Temp (Degrees Fahrenheit)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme
  
 print(AlaskaTemperatureMap)
```

# Comparison of Mean Precipitation, Mean Discharge, and Mean Maximum Temperature by Bin 
```{r, fig.cap= c("Comparison of Mean Precipitation, Mean Discharge, and Mean Maximum Temperature across Alaska by Bin"),fig.height=14, fig.width=20}
CompleteAlaskaPlotGrid<-plot_grid(AlaskaPrecipMap, AlaskaDischargeMap, AlaskaTemperatureMap,
            nrow = 3) 
print(CompleteAlaskaPlotGrid)
```


# Analysis

<Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.>

<Each figure should be accompanied by a caption, and each figure should be referenced within the text>

```{r, fig.cap = "Year vs. Day of Year of Peak Discharge. Bin 5 is the only Latitude Bin with a significant change in the day of year of peak discharge (p = 0.02353). There is a decreasing trend in the data, indicating the day of peak snowmelt is happening sooner across 1952-2018."}

Snowmelt.Discharge.Bin5 <- Snowmelt.Discharge.Spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>%
  filter(Bin == 5)

Snowmelt.Discharge.Peaks5 <- Snowmelt.Discharge.Bin5 %>% 
  filter(!is.na(Discharge)) %>% 
  group_by(YEAR) %>%
  mutate(Is.Peak = case_when(Discharge == max(Discharge) ~ TRUE, 
                             Discharge != max(Discharge) ~ FALSE), 
         Is.First.Peak = cumsum(Is.Peak)) %>%
  filter(Is.First.Peak == 1 & Is.Peak == TRUE) %>%
  select(YEAR, DOY)

#DOY vs Year
DOY.Time5 <-
ggplot(Snowmelt.Discharge.Peaks5, aes(x = YEAR, y = DOY)) +
  geom_point() +
 geom_smooth(method = lm, se = FALSE, color = "#c13d75ff") +
  labs(x = "", y = "Day of Year of Peak Discharge") + 
  theme(plot.title = element_text(margin = margin(b = -10), size = 12), 
       axis.title.x = element_blank())
print(DOY.Time5) #earlier

bin5.lm <- lm(YEAR ~ DOY, data = Snowmelt.Discharge.Peaks5)
summary(bin5.lm) #IT IS SIGNIFICANT!!! p-value = 0.02 so it's earlier


```



```{r}

# Snowmelt_BinSummary <- 
#   read.csv("../DATA/PROCESSED/Snowmelt_BinSummary.csv")
# 
# kable(Snowmelt_BinSummary, format = "latex", 
#       row.names = FALSE, 
#       #col.names = c("Latitude Bin", "Change in Day of Year"),
#       align = "c") %>%
#   kable_styling(bootstrap_options = c("striped", "condensed"),
#                 full_width = FALSE,
#                 font_size = 15) %>%
#   column_spec(column = 1, bold = TRUE) %>%  #columns must be specified by number
#   row_spec(row = 0, color = "#660033") %>%  #row = 0 allows us to format the header
#   row_spec(row = 5, color = "#104e8b", background = "#d3d3d3") 

```

# Calculate Cumulative Annual Precipitation for each year by Site
```{r}
## Create Year and Cumulative Precipitation columns in a new dataframe
CumAnnualPrecip<- AlaskaTempPrecipDischarge%>% mutate(Year = year(DATE)) %>% group_by(site_no, Year)%>% summarize(CumPrecip=sum(PRCP, na.rm=TRUE))

### Load in NWIS_SiteInfo.csv which has Drainage Areas for each Station
NWIS_SiteInfo<- read.csv("../DATA/RAW/NWIS_SiteInfo.csv")

# Join NWIS_SiteInfo and CumAnnual Precip by Site Number and multiply cumulative precipitation for each station and year by drainage area to determine water volume for each year and station
PrecipVolume<-CumAnnualPrecip%>%
merge(NWIS_SiteInfo, by='site_no')%>% mutate(Water_Volume=CumPrecip*drain_area_va)%>% select(site_no:dec_long_va, drain_area_va, Water_Volume )


```


## Question 1: <insert specific question here and add additional subsections for additional questions below>

## Question 2: 


The Climate Science Special Report estimates that maximum temperature increases in Alaska since between the first half of the 20th century and the past 30 years have been 1.43 degrees F (https://science2017.globalchange.gov/chapter/6/).

\newpage

# Summary and Conclusions
<Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.>

\newpage

# References
<add references here> 
Serreze, M. C., Barrett, A. P., Stroeve, J. C., Kindig, D. N., and Holland, M. M.: The emergence of surface-based Arctic amplification, The Cryosphere, 3, 11â€“19, https://doi.org/10.5194/tc-3-11-2009, 2009.
