---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Climatic Trend Impact on Alaskan Stream Discharge"
subtitle: "https://github.com/wgrimshaw/Alaska_DBPs.git"
author: "Gaby Garcia, Walker Grimshaw, Tristen Townsend, Yixin Wen"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage

<**General Guidelines**>
<1. Write in scientific style> 
<2. [Global options for R chunks](https://rmarkdown.rstudio.com/lesson-3.html) should be set so that only relevant output is displayed>
<3. Make sure your final knitted PDF looks professional. Format tables appropriately, size figures appropriately, make sure bulleted and numbered lists appear as such, avoid awkwardly placed page breaks, etc.>

```{r setup, include=FALSE}
## Global options to not print warning or messages
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
# Set your working directory

# Load your packages
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(tseries)
library(sf)
library(maps)
library(dataRetrieval)
library(viridis)
library(ggplot2)
library(sf)
#library(ggspatial)
library(cowplot)
library(kableExtra)
library(scales)


# Set your ggplot theme
theme_set(theme_bw())

# Load your datasets

AlaskaTempPrecipDischarge <- 
  read.csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")

```


# Rationale and Research Questions

<Write 1-2 paragraph(s) detailing the rationale for your study. This should include both the context of the topic as well as a rationale for your choice of dataset (reason for location, variables, etc.) A few citations should be included to give context for your topic. You may choose to configure autoreferencing for your citations or add these manually.>


## Background

The climate is changing, in large part due to anthropogenic carbon emissions. These changes have different magnitudes around the world and local impacts of climate change vary as well. Specifically, climate change is already having greater impacts near the poles than many other parts of the globe, a process known as polar amplification or arctic amplification (Serreze et al 2009). Understanding how climate change is affecting discharge, especially in Alaska, has implications for water management, ecological processes, and the larger global system (if we consider ice-albedo feedback) (Kashiwase et al, 2017). Many communities rely on a given amount of water from snowmelt to arrive at certain times of the year, so a shift in the quantity or timing could drastically affect downstream users and water managers (Earth System Research Laboratory, 2017). Additionally, changing the amount of flow in rivers could affect sensitive biological communities (U.S. Geologic Survey). Furthermore, changes in temperature that result in glacial or permafrost melting could reduce the amount of reflective land cover, thus disrupting larger climate systems.

<At the end of your rationale, introduce a numbered list of your questions (or an overarching question and sub-questions). Each question should be accompanied by one or more working hypotheses, inserted beneath each question.>

## Research Question

To what degree does climate change affect discharge in Alaskan streams and rivers?

This guiding question encompasses other questions we seek to answer through statistical analyses. If climate change is causing average temperatures to increase, and the magnitude of the increase is greater at higher latitudes, then higher latitude streams should demonstrate greater changes in timing and magnitude of peak flows. This study first seeks to examine if the magnitude of temperature changes increase with increasing latitude in Alaska. By analyzing historical streamflow records, we will investigate whether the magnitude of maximum daily temperature change causes a proportional change in the magnitude and timing of peak streamflow. 

Another aspect of climate change's impacts on streamflow is the potential of melting permafrost or glaciers. This analysis uses cumulative annual streamflow and cumulative annual precipitation to determine if interannual snowpack is melting with increasing average temperatures. If so, we expect the difference between annual precipitation and annual streamflow to increase over time.

1) Streams at varying latitudes will have different responses to changing climate with a monotonic trend related to latitude.

2) If streams are in areas that experience greater mean air temperature increases, then they will have greater discharge.

3) If temperature increases over time, the day of year of first snowmelt will occur earlier.


\newpage

# Dataset Information

<Provide information on how the dataset for this analysis were collected, the data contained in the dataset, and any important pieces of information that are relevant to your analyses. This section should contain much of same information as the metadata file for the dataset but formatted in a way that is more narrative.>

## Discharge

Discharge data were collected from the National Water Information System (NWIS) using the Data Retrieval package in R. The state of Alaska was divided into 10 bins of equal latitude, and daily discharge data was downloaded for the site in each latitude bin with the greatest number of samples. This dataset includes the site location, daily discharge, and county of the site, among other variables not used in the analysis.

Site information for each discharge site was also collected using the Data Retrieval package. Site information used in the analyses included upstream catchment area.

## Temperature and Precipitation

Temperature and precipitation data were downloaded from the National Oceanic and Atmospheric Administration (NOAA) Climate Data Online web portal. As discharge stations do not collect data on temperature and precipitation, the climate data for each latitude bin were downloaded from a station in the same county as each selected discharge station. In each county, daily precipitation, maximum temperature, and minimum temperature, data were downloaded from one station. The criteria for station selection include data extending to the current date, beginning at the earliest date, with at least 80% data coverage. This dataset also includes site location.


\newpage

# Data Wrangling

<Add a table that summarizes your data structure (variables, units, ranges and/or central tendencies, data source if multiple are used, etc.). This table can be made in markdown text or inserted as a `kable` function in an R chunk. If the latter, do not include the code used to generate your table.>

| Variable | Units (if known) | Type of Variable | Hypothesis | 
|------:|:-----|---------|:------:|
| Discharge | Cubic feet per second | Response | 1a, 1b, 1c |
| Site Number | Latitude/Longitude | Predictor | 1a |
| Date Time | Year/Month/Day | Predictor | 1c |
| Date of First Snowmelt | Year/Month/Day | Predictor | 1a, 1b, 1c |
| Air Temperature | Celsius | Predictor | 1b |
| Precipitation | Millimeters | Predictor | 1a, 1c |
| HUC 8 Watershed Size | Square Meters | Predictor | 1a, 1b | 
| Permafrost Melt | Qualitative | Predictor | 1b | 
| Glacial Coverage/Melting | Qualitative | Predictor | 1b |

# Data Wrangling Methods

### Importing, Cleaning, and Addressing Date Issues

The state of Alaska was divided into 10 bins of equal latitude. Precipitation and temperature data for 10 Alaskan NOAA stations-one inside each latitude bin-was obtained from NOAA's Climate Data Online web portal, and discharge data was retrieved from NWIS's Data Retrieval package using one site in each latitude bin with the greatest number of samples. All discharge data resided in one CSV entitled NWIS_Discharge. All raw CSVs were imported into our Raw Data folder within our project repository on Github, and imported into R using the read.csv function. 

Each of the 10 NOAA stations classified by latitude bin had a unique CSV that was cleaned prior to joining. Ancillary columns from each of the 10 dataframes were removed in order to ensure that each CSV had the same columns in the same order. In order to address date-time issues in the NOAA CSVs for Bin 1 and Bin 5, the as.DATE function was used to change the "DATE" column fron a factor to a date, in the format month/day/year. Next, we changed the format of the "DATE" column to a two digit year, a two digit month, and the two digit day. A function was then written to create early dates that had been misrepresented as years after 2019. Then, the DATE column was inserted into the function written above for each row of the DATE column. Finally, the as.DATE function was used to convert the DATE column into a 4 digit year, a two digit month, and 2 digit day format, our preferred format. 

### Joining Data
After all 10 NOAA dataframes containing precipitation and temperature data were cleaned, they were all joined by row using the rbind function into a new CSV entitiled "TempPrecip". Next, the "site_no" column in the NWIS_Discharge dataframe was converted into a factor using the as.factor function. The revalue function within the "plyr" package was then used to create a new "Bin" column renaming the USGS Station Numbers in the "site_no" column by their bin number. The "Date" column in the Discharge dataframe was renamed to "DATE" so that it matched the "DATE" column in the "TempPrecip" dataframe. Finally, the merge function was used to join the "TempPrecip" and "NWIS_Discharge" dataframes by "DATE" and "Bin" into a new CSV entitled "AlaskaTempPrecipDischarge", and cleaned for clarity. 

# Exploratory Analysis 

<Insert exploratory visualizations of your dataset. This may include, but is not limited to, graphs illustrating the distributions of variables of interest and/or maps of the spatial context of your dataset. Format your R chunks so that graphs are displayed but code is not displayed. Accompany these graphs with text sections that describe the visualizations and provide context for further analyses.>

<Each figure should be accompanied by a caption, and each figure should be referenced within the text>

## Site Locations

```{r Exploratory Precipitation Mapping Data Wrangling, warning=FALSE, message=FALSE}
# Convert the Alaska dataset to a spatially enabled "sf" data frame
AlaskaTempPrecipDischarge_sf<- st_as_sf(AlaskaTempPrecipDischarge,coords = c('LONGITUDE','LATITUDE'),crs=4326)

# Load in US Census Bureau Cartographic Boundary Shapefiles and Filter for Alaska Only

State_sf<- st_read('../DATA/RAW/cb_2018_us_state_20m.shp') 
Alaska_sf<-filter(State_sf, NAME == 'Alaska')

# Create summary dataframe with only NOAA site locations

## NOAA site locations
NOAA_sites <- c("USC00500464", "USC00502107", "USW00025325", "USW00025624",
                "USW00025704", "USW00026451", "USW00026510", "USW00026615",
                "USW00027502", "USW00027502")
NOAA_Lat <- c(58.3814, 64.8603,	55.35, 55.2207,
              51.88333, 61.169, 62.9574, 60.785,
              71.2834, 71.2834)
NOAA_Lon <- c(-134.645, -147.8484, -131.65, -162.7324,
              -176.65, -150.0278, -155.6103, -161.8293,
              -156.7815, -156.7815)

## Combine and add bin number by sorting by latitude
NOAA_site_data <- data.frame(cbind(NOAA_sites, NOAA_Lat, NOAA_Lon)) %>%
  arrange(NOAA_Lat) %>%
  mutate(Bin = c(1,2,3,4,5,6,7,8,9, 10),
         NOAA_Lat = as.numeric(as.character(NOAA_Lat)),
         NOAA_Lon = as.numeric(as.character(NOAA_Lon)))

NOAA_sf <- st_as_sf(NOAA_site_data, coords = c("NOAA_Lon", "NOAA_Lat"),
                         crs = 4326)

## Convert all SF Layers to UTM Projection 
NOAA_sf_utm  <- st_transform(NOAA_sf, c=32609)
Alaska_sf_utm <-st_transform(Alaska_sf,c=32609)

# Create Discharge Sites Dataframe in NAD83
## discharge lat and lon in NAD83
discharge_sites <- readNWISsite(c("15052500", "15072000","15276000", "15297610",
                                "15297680", "15304000", "15453500", "15514000",
                                "15896000", "15908000")) %>%
  select(site_no, dec_lat_va, dec_long_va) %>%
  arrange(dec_lat_va) %>%
  mutate(Bin = c(1,2,3,4,5,6,7,8,9,10)) %>%
  rename(discharge_site = site_no, discharge_lat = dec_lat_va,
         discharge_long = dec_long_va) %>%
  mutate(discharge_lat = as.numeric(as.character(discharge_lat)),
         discharge_long = as.numeric(as.character(discharge_long)))


```


```{r Exploratory Precipitation Mapping}
# Create Alaska Temp Precip Discharge Summary using Summarize function
### Convert Bin Column to a factor
AlaskaTempPrecipDischarge$Bin<-as.factor(AlaskaTempPrecipDischarge$Bin)

## Create Summary
AlaskaMeanPrecipDischargeSummary<-AlaskaTempPrecipDischarge%>%
  group_by(Bin)%>%
  summarize(Lat_Mean=mean(LATITUDE),
            Long_Mean=mean(LONGITUDE),
            Mean_PRCP=mean(PRCP, na.rm=TRUE),
            Mean_Discharge=mean(Discharge, na.rm=TRUE),
            Mean_Max_Temp=mean(TMAX, na.rm=TRUE),
            Mean_Min_Temp=mean(TMIN, na.rm=TRUE))
            

### Convert AlaskaMeanPrecipDischarge Summary to a spatially enabled SF dataframe
AlaskaMeanPrecipDischargeSummary_sf<- st_as_sf(AlaskaMeanPrecipDischargeSummary,coords = c('Long_Mean','Lat_Mean'),crs=4326)

### Transform SF Data to UTM Zone 9N Projection for Alaska
AlaskaMeanPrecipDischargeSummary_utm<- st_transform(AlaskaMeanPrecipDischargeSummary_sf, c=32609)

# Join Discharge Sites dataframe to AlaskaMeanPrecipDischarge Summary
DischargeComplete<- AlaskaMeanPrecipDischargeSummary %>%
  merge(discharge_sites, by ='Bin')

## Convert DischargeComplete DF to a Spatial Features DF
DischargeComplete_sf<- st_as_sf(DischargeComplete,
                              coords = c("discharge_long", "discharge_lat"),
                              crs = 4326)

### Convert SF Dataframe to NAD 83 Zone 9N Projection 
DischargeComplete_utm<- st_transform(DischargeComplete_sf, c=32609)
```


```{r, fig.cap= c("Map of NOAA Site Locations in Alaska. The red sites are NOAA stations where we obtained our climate (temperature and precipitation) data, while the blue sites are the NWIS Stations where we obtained our discharge data. There is one NOAA station and one NWIS station per latitude bin; the station pairs were not colocated and were chosen on the basis of having the longest period of record. Each station pair was located within the same county, however."), fig.height=5, fig.width=8, warning=FALSE, message=FALSE}
gabytheme <- theme_bw(base_size = 20) + 
  theme(plot.title=element_text(face="bold", size="22", color="IndianRed4", hjust=0.5),
        axis.title=element_text(size=19, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"))


ggplot() +
  geom_sf(data = Alaska_sf_utm, color = "black") +
  geom_sf(data = NOAA_sf_utm, color = "red", size=5)+
  geom_sf(data = DischargeComplete_utm, color="blue", size=5) +
gabytheme
```

## Temperature

Though climate change is a complex process, the easiest parameter to estimate the magnitude of climate change is temperature. Figure XXX shows the maximum daily temperature for the nine NOAA sites over each site's period of record. As expected, the range of maximum temperature increases with increasing latitude. Besides site one, all other sites have reasonable overlap in their periods of record and at least cover from 1980 to 2018. There are gaps in the records of multiple sites that require interpolation however. Larger gaps, such as the 1990s gap for site two and the gaps before 1950 for site three, are not filled in this analysis, and instead the earlier time periods are left out of the time series analysis. Shorter data gaps are filled.

```{r Exploratory Temperature Figure}
## Data wrangling
## transform date column from factor to date
AlaskaTempPrecipDischarge$DATE <-
  as.Date(AlaskaTempPrecipDischarge$DATE, format = "%Y-%m-%d", origin = "1970-01-01")

## create  NA rows where there are data gaps so lines don't connect
Bin2NA <- c(as.Date("1990-01-01", format = "%Y-%m-%d", origin = "1970-01-01"), 2, rep(NA, 11))
Bin3NA <- c(as.Date("1945-01-01", format = "%Y-%m-%d", origin = "1970-01-01"), 3, rep(NA, 11))
Bin3NA_2 <- c(as.Date("1936-01-01", format = "%Y-%m-%d", origin = "1970-01-01"), 3, rep(NA, 11))
Bin4NA <- c(as.Date("1996-01-01", format = "%Y-%m-%d", origin = "1970-01-01"), 4, rep(NA, 11))
Bin6NA <- c(as.Date("1995-01-01", format = "%Y-%m-%d", origin = "1970-01-01"), 6, rep(NA, 11))

## rbind missing date vectors
MissingDates <- as.data.frame(rbind(Bin2NA, Bin3NA, Bin3NA_2, Bin4NA, Bin6NA))
## match names to Alaska Data names
names(MissingDates) <- names(AlaskaTempPrecipDischarge)
## reformat date column
MissingDates$DATE <- as.Date(MissingDates$DATE)
Alaska_Data_TempFig <- rbind(AlaskaTempPrecipDischarge, MissingDates)
  
## create plot of temperature over time for all 10 latitude bins
ggplot(Alaska_Data_TempFig, aes(x = DATE, y = TMAX)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~Bin, nrow = 3, ncol = 3) +
  labs(y = "Maximum Daily Temperature (F)", x = "Date")
```

## Snowmelt

Recognizing climate change can affect conditions which dictate the timing of snowmelt, we chose to investigate whether timing was in fact changing over time. In order to minimize inconsistencies in period of records for the data across various latitude bins, discharge was used as a proxy for changes in snowmelt. Figure XX1 shows day of year versus mean discharge for all latitude bins. Figure XX2 is similar to Figure XX1 but excludes latitude bins 6 and 8, in order to better visualize how mean discharge changed throughout the year on average for the other latitudes. These graphs were made to provide insight into the variability of when snowmelt had been occuring at the various latitude bins. Graphs exploring day of year compared to discharge were for all latitude bins.Figure XX3 shows day of year compared to discharge for only latitude bin 6. This latitude bin was of interest as it exhibited the trend we expected, a spike in discharge occurring sooner for years later in the period of record. Even when looking at only six years at a time, as seen in Figure XX4, the same trend is clear. 


```{r Snowmelt Exploratory Data Wrangling, echo=FALSE}
 
#Convert DATE column to class 'Date'
AlaskaTempPrecipDischarge$DATE <- ymd(AlaskaTempPrecipDischarge$DATE)

#Add date columns
Snowmelt.Discharge <- AlaskaTempPrecipDischarge %>% mutate(YEAR = year(DATE), MONTH = month(DATE), 
                        DAY = day(DATE), WEEK = week(DATE), 
                        DOY = yday(DATE))

Snowmelt.Discharge.Spring <- Snowmelt.Discharge %>% filter(WEEK < 30)

Snowmelt.Discharge.Bin6 <- Snowmelt.Discharge.Spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>%
  filter(Bin == 6)

#Plot mean discharge for each DOY through time by bin
Snowmelt.Discharge.Mean <- Snowmelt.Discharge.Spring %>% group_by(as.factor(Bin), as.factor(DOY)) %>%
  mutate(Dis.Mean = mean(Discharge))

```


# Snowmelt Graph 1
```{r Snowmelt Day of Year Exploratory Graph 1}
dis.doy.mean <- ggplot(Snowmelt.Discharge.Mean) +
  geom_line(aes(x = DOY, y = Dis.Mean, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Mean Discharge", color = "Latitude Bin") +
  scale_color_viridis_d() +
  theme(legend.position = "top") +
  labs(x = "Day of Year", y = "Mean Discharge, cfs") + theme(legend.position = "right",
        axis.title.y = element_text(margin = 
          margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = 
          margin(t = 10, r = 0, b = 0, l = 0))) +
  scale_y_continuous(limits = c(0,400000), labels = comma)
print(dis.doy.mean)
```

Figure XX1:  Day of Year vs. Mean Discharge. This figure shows mean discharge across all nine latitude bins for each day of the year. This graph served to illustrate variation across sites as to when first day of snowmelt and peak snowmelt would occur.

# Snowmelt Graph 2
```{r Snowmelt Day of Year Exploratory Graph 2}
dis.doy.mean2 <- ggplot(Snowmelt.Discharge.Mean) +
  geom_line(aes(x = DOY, y = Dis.Mean, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Mean Discharge", color = "Latitude Bin") +
  scale_color_viridis_d() +
  theme(legend.position = "top") +
  labs(x = "Day of Year", y = "Mean Discharge, cfs") + theme(legend.position = "right",
        axis.title.y = element_text(margin = 
          margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = 
          margin(t = 10, r = 0, b = 0, l = 0))) +
  scale_y_continuous(limits = c(0,7500), labels = comma)
print(dis.doy.mean2)
```


# Snowmelt Graph 3
```{r Snowmelt Day of Year Exploratory Graph 3}
dis.doy.6 <- ggplot(Snowmelt.Discharge.Bin6) +
  geom_line(aes(x = DOY, y = Discharge, color = YEAR)) +
  labs(x = "Day of Year", y = "Discharge, cfs", color = "Year") +
  scale_color_viridis_c() +
  theme(legend.position = "right") + 
  theme(legend.position = "right",
        axis.title.y = element_text(margin = 
          margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = 
          margin(t = 10, r = 0, b = 0, l = 0))) +
  scale_y_continuous(limits = c(0,400000), labels = comma)
print(dis.doy.6)
```

Figure XX3: Day of Year vs. Discharge. This figure shows how discharge changes with day of year across the entire period of record for Bin 6. This provided a visual cue as to whether snowmelt was occuring earlier and during what time of the year the shift was occuring.

# Snowmelt Graph 4 
```{r Snowmelt Day of Year Exploratory Graph 4}
Snowmelt.Discharge.Bin6.10Year <- Snowmelt.Discharge.Bin6 %>% 
  filter(YEAR == 1969 | YEAR == 1979 | YEAR == 1989 | YEAR == 1999 | YEAR == 2009 | YEAR == 2019)

dis.doy.6.10 <- ggplot(Snowmelt.Discharge.Bin6.10Year) +
  geom_line(aes(x = DOY, y = Discharge, color = as.factor((YEAR)))) +
  labs(x = "Day of Year", y = "Discharge, cfs", color = "Year") +
  scale_color_viridis_d() + 
  theme(legend.position = "right",
        axis.title.y = element_text(margin = 
          margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = 
          margin(t = 10, r = 0, b = 0, l = 0))) +
  scale_y_continuous(limits = c(0,250000), labels = comma) +
  guides(color = guide_legend(reverse=TRUE))
print(dis.doy.6.10)

```

Figure XX4: Day of Year vs Discharge. This figure shows how discharge changes with day of year every ten years across the period of record for fifty years. This provided a visual cue as to whether snowmelt was occuring earlier and during what time of the year the shift was occuring.

# Precipitation 

While there are significant regional and seasonal differences in precipitation changes, the mean annual precipitation across the United States has increased about 4% from the 1901-2015 period of record (Walsh et al. 2014). Long-term station observations from core climate networks served as a primary source to establish observed changes in precipitation. Alaska shows little change in annual precipitation (+1.5%); however, in all seasons, central Alaska shows declines and the panhandle shows increase (Easterling et al., 2017). 

Figure XXX shows precipitation over each of the nine NOAA site's period of record, colored by bin. As expected, Bin 3 clearly has the largest range in the magnitude of precipitation, and precipitation in Alaska appears to decrease with increasing latitude.
This is substantiated by the fact that currently dry regions in Alaska are projected to become drier due to accelerated evaporation caused by warmer temperatures and longer growing seasons, while wet areas are projected to become wetter (EPA, 2017). Bin 3's station is located in Ketchikan, Alaska, which has a temperate oceanic climate and is dubbed the "rainfall capital of Alaska". There are 2 main data gaps in the precipitation period of record. One large gap occurs from the mid to late 1930s, presumably due to the Great Depression, and the second large gap occurs from August 31, 1942 to January 1st, 1948, presumably due to the second World War. These two gaps are not filled in this analysis. 
```{r Precipitation Exploratory Data Wrangling}
### Create Precipitation only Dataframe with Bins included
AlaskaPrecipOnly<-select(AlaskaTempPrecipDischarge, .data$DATE, .data$PRCP, .data$Bin)
### Rename data frame
newdata<-AlaskaPrecipOnly

### Ensure Date is a date object and not a factor
newdata$DATE<-as.Date(newdata$DATE)

### Ensure Bin is a factor and not an integer
newdata$Bin <- as.factor(newdata$Bin)

# Subset the Data by Bin
Bin1Precip<-filter(newdata, Bin== 1)
Bin2Precip<-filter(newdata, Bin== 2)
Bin3Precip<-filter(newdata, Bin == 3)
Bin4Precip<-filter(newdata, Bin == 4)
Bin5Precip<-filter(newdata, Bin == 5)
Bin6Precip<-filter(newdata, Bin == 6)
Bin7Precip<-filter(newdata, Bin == 7)
Bin8Precip<-filter(newdata, Bin == 8)
Bin9Precip<-filter(newdata, Bin == 9)

### Ensure Date is a date object and not a factor
 newdata$DATE<-as.Date(newdata$DATE)
 
### Ensure Bin is a factor and not an integer
 newdata$Bin <- as.factor(newdata$Bin)
 
### Add Day of Year, Year, Week,and Month Column
newdata <-mutate(newdata, DOY = yday(DATE), Year=year(DATE), Month=month(DATE), WEEK = week(DATE))

# Subset the Data by Bin
Bin1Precip<-filter(newdata, Bin== 1)
Bin2Precip<-filter(newdata, Bin== 2)
Bin3Precip<-filter(newdata, Bin == 3)
Bin4Precip<-filter(newdata, Bin == 4)
Bin5Precip<-filter(newdata, Bin == 5)
Bin6Precip<-filter(newdata, Bin == 6)
Bin7Precip<-filter(newdata, Bin == 7)
Bin8Precip<-filter(newdata, Bin == 8)
Bin9Precip<-filter(newdata, Bin == 9)

### Set personal theme
gabytheme <- theme_bw(base_size = 17) + 
  theme(plot.title=element_text(face="bold", size="26", color="IndianRed3", hjust=0.5),
        axis.title=element_text(size=22, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"),
legend.key.size=unit(1, "cm"))

```


## Scatterplot of Full Precipitation Period of Record Colored by Bin
```{r Precipitation Exploratory Graph 1, fig.cap= c("Precipitation Measured Over the Entire Period of Record by Bin. This figure shows the general pattern of precipitation changes over time, differentiated by the latitude bin (color). Bin 3 has the most sample points for the entire precipitation period of record. Bin 3's precipitation range has the greatest magnitude compared to the other bins."),fig.width=10, fig.height=6}
 PrecipScatterplot<-ggplot(newdata, aes(x = DATE, y = PRCP, color = Bin))  +
   geom_point(alpha=0.3, size=2) +
 labs( x="Year",
        y="Precipitation (inches)")+
  theme(legend.position="top")+
   gabytheme
 print(PrecipScatterplot)
```



```{r}
# Group Precip Data by Bin and DOY, create Mean Precip column, and filter weeks to only include the spring
Precip.Mean.Spring<-newdata%>%
  group_by(as.factor(Bin),as.factor(DOY))%>%
mutate(MeanPRCP=mean(PRCP))%>%
 filter(WEEK < 30)

# Filter for Bin 6            
 Precip.Mean.Bin6 <- Precip.Mean.Spring %>% 
   filter(Bin == 6)
```


```{r, fig.cap= c("Day of Year vs. Mean Precipitation. This figure shows mean precipitation across all nine latitude bins for each day of the year up until Day 200. This graph served to illustrate precipitation variation across sites. Bin 1 has the greatest spread of mean precipitation."), fig.width=12, fig.height=7}
 PrecipMeanSpringPlot<- ggplot(Precip.Mean.Spring) +
   geom_line(aes(x = DOY, y = MeanPRCP, color = Bin)) +
   labs(x = "Day of Year", y = "Mean Precipitation (inches)", color = "Latitude Bin") +
scale_colour_manual(values = c("#00CED1", "#000000", "#FFFF00", "#FF8C00", "#9400D3", "#FF0000", "#228B22", "#FF00FF", "#CD5C5C"))+

  theme(legend.position = "top")+
  gabytheme
 print(PrecipMeanSpringPlot)
 
```


```{r, fig.cap= c("Day of Year vs. Precipitation. This figure shows how precipitation changes with day of year across the period of record for Bin 6."), fig.width=7,fig.height=5}
 PrecipSpringBin6Plot<- ggplot(Precip.Mean.Bin6) +
   geom_line(aes(x = DOY, y = PRCP, color = Year)) +
   labs(x = "Day of Year", y = "Precipitation (inches)", color = "Year") +
scale_color_viridis_c()+
  gabytheme
 print(PrecipSpringBin6Plot)
```




# Mean Precipitation Map
```{r fig.cap=c("Map of Mean Precipitation across Alaska by Bin. This map depicts Bin 3 as having the highest mean precipitation across the state, with the lowest mean precipitation falling in northernmost Bin 9."), fig.height=5, fig.width=9}
AlaskaPrecipMap<-ggplot(axes = FALSE) +
  geom_sf(data = Alaska_sf_utm, fill="white", color="black") +
  geom_sf(data = AlaskaMeanPrecipDischargeSummary_utm, aes(color=Mean_PRCP), size=5)  +
  
  
  labs(color="Mean Precipitation (inches)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme

 print(AlaskaPrecipMap)
```
\newpage

# Mean Discharge Map
```{r,fig.cap= c("Map of Mean Discharge across Alaska by Bin. This map depicts Bin 8 as having the highest mean discharge value of 121,266.11 cfs. Bin 1 has the lowest mean discharge value of 4.69 cfs."), fig.height=5, fig.width=9}
gabytheme2 <- theme_bw(base_size = 17) + 
  theme(plot.title=element_text(face="bold", size="26", color="IndianRed3", hjust=0.5),
        axis.title=element_text(size=22, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"),
legend.key.size=unit(2, "cm"))

AlaskaDischargeMap<-ggplot(axes = TRUE) +
  geom_sf(data = Alaska_sf_utm, fill="white") +
  geom_sf(data = DischargeComplete_utm, aes(color=Mean_Discharge), size=5)  +
  labs(color="Mean Discharge (cubic feet/s)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme2
  
 print(AlaskaDischargeMap)
```
\newpage


```{r fig.cap=c("Map of Mean Maximum Temperature across Alaska by Bin. This figure depicts Bin 3 as having the highest mean maximum temperature value of 51.97 degrees Fahrenheit."), fig.height=5, fig.width=9}
AlaskaTemperatureMap<-ggplot(axes = TRUE) +
  geom_sf(data = Alaska_sf_utm, fill="white") +
  geom_sf(data = AlaskaMeanPrecipDischargeSummary_utm, aes(color=Mean_Max_Temp), size=5)  +
  labs(color="Mean Max Temp (Degrees Fahrenheit)")+
annotation_north_arrow(location = "tl", which_north = "true", pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
  scale_color_viridis_c(option="viridis", direction=-1)+
  annotation_scale(width_hint = 0.5)+
  gabytheme
  
 print(AlaskaTemperatureMap)
```

# Discharge Data Wrangling

To analyze the seasonal change of discharge, it is helpful to know the general trend of discharge over time. Figure Seasonal Change of Discharge 1-1 shows the discharge of 9 bins over time. From this graph, it is clear to see that Bin 6 and 8 have 2 largest river and they also have obvious seasonal changes. Trend of discharge of other bins cannot be identify right now and need further analysis.

```{r Discharge Exploratory Data Wrangling, echo=FALSE}
# transform bin and Date into factor
AlaskaTempPrecipDischarge$Bin <- as.factor(AlaskaTempPrecipDischarge$Bin)

AlaskaTempPrecipDischarge$DATE <- as.Date(AlaskaTempPrecipDischarge$DATE,
                                          format = "%Y-%m-%d")
#Extract date and discharge data
AlaskaDischarge <- AlaskaTempPrecipDischarge%>%
  select("DATE", "Bin","STATION","NAME", "site_no", "Discharge")
#drop na
AlaskaDischarge<-AlaskaDischarge%>%drop_na()

# plot discharge changes over time for 9 latitude bins
discharge_plot <- ggplot(AlaskaDischarge,aes(x = DATE, y = Discharge))+
  geom_line()+ # add a representative line
  facet_wrap(~Bin, nrow = 3, ncol = 3)+
  labs(x = "Date", y =expression("Discharge (ft"^3*"/s)"))+
  theme(text = element_text(size=18))
print(discharge_plot)

```


# Analysis

<Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.>

<Each figure should be accompanied by a caption, and each figure should be referenced within the text>

## Temperature Trends

For each latitude bin, the monthly average maximum temperature was calculated from the daily temperature data. As previously mentioned, the earlier data for sites two and three were discarded and not used for analysis. All other data gaps of at least one year in length were filled using the average maximum temperature for each month over the period of record for each site. However, if there were shorter data gaps of less than one year in length, monthly maximum temperatures were filled using linear interpolation from the nearest neighbor points.

For each latitude bin, a Seasonal Mann-Kendall test was performed on the monthly time series to determine if there had been a change in temperature over the period of record and the directionality of the trend. The Seasonal Mann-Kendall was also used to determine which individual months had statistically significant temperature trends and the directionality of those trends. If there was a statistically significant trend over the period of record, the seasonal sen's slope test was used to determine the average magnitude of the change.

Figure XXX shows the monthly average maximum temperature for site 5, near Anchorage, over time. The monthly average maximum temperature had a statistically significant trend (Seasonal Mann-Kendall, z=4.87, p<0.001). The blue line shows the magnitude of this trend as calculated by the seasonal sen's slope, indicating a 0.04 degree fahrenheit annual increase in average maximum temperature. It should be noted that the statistical tests used here do not estimate the intercept of the seasonal trend line, so while the figure shows the average seasonal temperature increase, the location of the intercept is only an approximation to assist the visualization.

```{r Temperature Analysis}
# Make column of predicted temp
Alaska_Temp_Monthly_5 <- read.csv("./DATA/PROCESSED/Alaska_Temp_Monthly_5.csv")

ggplot(Alaska_Temp_Monthly_5, aes(x = Date)) +
  geom_line(aes(y = aveTMAX)) +
  geom_line(aes(y = Prediction), color = "blue", size = 1) +
  labs(y = "Maximum Daily Temperature\nAveraged by Month (F)")
```


## Snowmelt Analysis

After looking at exploratory graphs, it was decided to use day of year of peak discharge as a proxy for snowmelt, instead of day of year of first large discharge increase. This was because peaks would be changing in a similar fashion, and it was more computationally feasible and efficient for analyses. For each latitude bin, the day of year of peak discharge was determined for each year. Then a linear model was made to determine if the day of year of peak discharge was significantly changing over time for each latitude bin. Only latitude bin 5 was found to have a significant change over time in the day of year of peak discharge. As seen in Figure XX, the decreasing trend in the data indicates that the day of year of peak discharge is occurring sooner for the later years.

```{r, Snowmelt Analysis figure}

Snowmelt.Discharge.Bin5 <- Snowmelt.Discharge.Spring %>% select(DATE, YEAR, MONTH, DAY, WEEK, DOY, Bin, NAME, LATITUDE, LONGITUDE, Discharge) %>%
  filter(Bin == 5)

Snowmelt.Discharge.Peaks5 <- Snowmelt.Discharge.Bin5 %>% 
  filter(!is.na(Discharge)) %>% 
  group_by(YEAR) %>%
  mutate(Is.Peak = case_when(Discharge == max(Discharge) ~ TRUE, 
                             Discharge != max(Discharge) ~ FALSE), 
         Is.First.Peak = cumsum(Is.Peak)) %>%
  filter(Is.First.Peak == 1 & Is.Peak == TRUE) %>%
  select(YEAR, DOY)

#DOY vs Year
DOY.Time5 <-
ggplot(Snowmelt.Discharge.Peaks5, aes(x = YEAR, y = DOY)) +
  geom_point() +
 geom_smooth(method = lm, se = FALSE, color = "#c13d75ff") +
  labs(x = "", y = "Day of Year of Peak Discharge") + 
  theme(plot.title = element_text(margin = margin(b = -10), size = 12), 
       axis.title.x = element_blank())
print(DOY.Time5) #earlier

bin5.lm <- lm(DOY ~ YEAR, data = Snowmelt.Discharge.Peaks5)
summary(bin5.lm) #IT IS SIGNIFICANT!!! p-value = 0.02 so it's earlier
```

Figure XX: Year vs. Day of Year of Peak Discharge. Bin 5 is the only Latitude Bin with a significant change in the day of year of peak discharge (p = 0.02353, DF = 65, R2 = 0.062). There is a decreasing trend in the data, indicating the day of peak snowmelt is happening sooner across 1952-2018.


## Calculate Cumulative Annual Precipitation and Cumulative Annual Discharge for each year by Site

We calculated the cumulative annual precipitation and discharge water volume for each year by site in cubic feet per year in order to create a column with the ratio of cumulative precipitation water volume: cumulative discharge water volume. This ratio indicates how the proportion of discharge that originates from precipitation. When the precipitation:discharge ratio is less than one, some proportion of discharge is a result from other hydrologic mechanisms such as glacier or permafrost melting. 

```{r}
## Calculate Cumulative Annual Precipitation for each year by Site and Create Dataframe
CumAnnualPrecip<- AlaskaTempPrecipDischarge%>%
  mutate(Year = year(DATE)) %>%
  group_by(site_no, Year)%>%
  summarize(CumPrecip=sum(PRCP, na.rm=TRUE))

### Load in NWIS_SiteInfo.csv which has Drainage Areas for each Station
NWIS_SiteInfo<- read.csv("../DATA/RAW/NWIS_SiteInfo.csv")

## Join NWIS_SiteInfo and CumAnnual Precip by Site Number and multiply cumulative precip for each station and year by drainage area to determine water volume for each year and station
PrecipVolume<-CumAnnualPrecip%>%
  merge(NWIS_SiteInfo, by='site_no')%>%
  mutate(Water_Volume_Precip=CumPrecip*drain_area_va*5280*5280/12)%>%
  select(site_no:dec_long_va, drain_area_va, Water_Volume_Precip)
### cum precip * drainage area(sq miles)* 5280 *5280/12=cubic feet per year 

# Determine Water Volume of Discharge by Bin and Site 

## Calculate Cumulative AnnualDischarge for each year by Site and Create Dataframe
CumAnnualDischarge<- AlaskaTempPrecipDischarge%>%
  mutate(Year = year(DATE)) %>%
  group_by(site_no, Year)%>%
  summarize(CumDischarge=sum(Discharge, na.rm=TRUE))

## Join NWIS_SiteInfo and CumAnnual Precip by Site Number and multiply cumulative precip for each station and year by drainage area to determine water volume for each year and station
library(dplyr)
DischargeVolume<-CumAnnualDischarge%>%
  merge(NWIS_SiteInfo, by='site_no')%>%
  mutate(Water_Volume_Discharge=CumDischarge*3600*24)%>%
  select(site_no:dec_long_va, drain_area_va, Water_Volume_Discharge)
#### Discharge is in cubic feet per second *3600 *24 to get discharge volume in cubic feet per year


## Join Discharge Volume and Precip Volume Data Frames and Create Ratio Column
PrecipDischargeVolume<-PrecipVolume%>%
  merge(DischargeVolume, by=c('site_no', 'Year'))%>%
  mutate(Precip_Discharge_Ratio=Water_Volume_Precip/Water_Volume_Discharge)

### Filter PrecipDischargeVolume Dataframe by Bin 5
PrecipDischargeVolumeBin5<-filter(PrecipDischargeVolume, site_no=='15276000')
```


# Bin 5 Precipitation:Discharge Plot
```{r, fig.width=4, }
Bin5RatioPlot<-ggplot(PrecipDischargeVolumeBin5, aes(x=Year, y=Precip_Discharge_Ratio))+
  geom_point(alpha=0.5, size=2, color="black")+
  geom_smooth(method="lm", se=FALSE)+
  labs(y="Precipitation:Discharge")+
  ggtitle("Bin 5: Year on Precipitation:Discharge Ratio")+
  gabytheme
print(Bin5RatioPlot)
```


# Create Linear Model of Year vs. the Precip: Discharge Water Volume Ratio
```{r}
PrecipDischargeLM<-lm(Precip_Discharge_Ratio~Year, data=PrecipDischargeVolume)
summary(PrecipDischargeLM)
```
>The final linear equation of this precipitation:discharge linear model is Y=-16.93 +
0.0092(Year). A one-year increase in time increases the precipitation:discharge ratio by 0.01 units. This trend is visible in Figure XXX. 





```{r, summary table}
## read in output files
Discharge_output <- read.csv("./DATA/PROCESSED/Discharge_Change_new.csv")
Snowmelt_output <- read.csv("./DATA/PROCESSED/Snowmelt_BinSummary.csv")
Temp_output <- read.csv("./DATA/PROCESSED/Temperature_Change.csv")

Discharge_output <- Discharge_output %>% mutate(Slope = Slope * 100)

## join by bin
Output_Summary <- Temp_output %>%
  left_join(Discharge_output, by = "Bin") %>%
  left_join(Snowmelt_output, by = "Bin") %>%
  rename(Discharge_Change = Slope) 
  
Output_Summary <- round(Output_Summary, digits = 2)
Output_Summary[is.na(Output_Summary)] <- "No change"


kable(Output_Summary, format = "html", 
       row.names = FALSE, 
       col.names = c("Latitude Bin", "Temperature Change, °F/yr", 
                     "Annual Percent Change in Discharge", "Change in Day of Year, days/yr"),
       align = "c",
       digits=2) %>%
   kable_styling(bootstrap_options = c("striped", "condensed"),
                 full_width = TRUE,
                 font_size = 15) %>%
   column_spec(column = 1, bold = TRUE) %>%  #columns must be specified by number
   row_spec(row = 0, color = "#660033") %>%  #row = 0 allows us to format the header
   row_spec(row = 5, bold = TRUE, color = "#104e8b", background = "#d3d3d3") 

```

# Seasonal Analysis of Discharge 

To analyze the seasonal treand of discharge of each bin, the monthly average discharge data are applied, which are calculated from the daily discharge data. In order to make sure the result is correct and reasonable, choosing the right period of time to do time series is very important. The criteria for selecting optimal period of records is to make sure it covers at least 30 years most recent data if possible. For Bin 1, it only has 5 years of data, which is not useful to do time series on it. For the gaps in the data, if there is a huge gap(>3 years), drop it to keep the most recent data, if the gap is small(<= 3 years), the average discharge of that month over periods is used to fill the gap. 

Seasonal Mann-Kendall tests are performed on the monthly time series to determine if there is a change in discharge over the period of record. If there is a statistically significant trend (p<0.05) over the period of record, the seasonal sen's slope test is used to determine the average magnitude of the change. In order to remove the impact of river volume, sens'slopes are normalized by divided by average discharge over period of records. Figure Seasonal Change of Discharge 2-1 shows that except for bin 1 and 3, discharge of other bins shows small seasonal change and since the sens'slopes are all positive, discharge is slightly increasing over time. However, there's no clear trend shows that seasonal change of discharge has positive or negative relationship with latitude, which cannot supports the hypothesis that climate change is having larger impacts near the poles.

```{r Discharge Seasonal Change Analysis}
## choose the optimal range of dataset of each bin. For missing monthly data, using mean value of that month over different years to fill the gap. Make sure the number of month is the same for each year in each bin.

#Bin 1
AlaskaDischarge_1.Monthly <- AlaskaDischarge %>%
  filter(Bin ==1)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year>=1968 & Year <= 1973)

#Bin 2
AlaskaDischarge_2.Monthly <- AlaskaDischarge %>%
  filter(Bin == 2)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1996 & Year <= 2018)

#Bin 3
AlaskaDischarge_3.Monthly <- AlaskaDischarge %>%
  filter(Bin == 3 )%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >=1989 & Year <= 2018)
  
#Bin 4
AlaskaDischarge_4_ori.Monthly <- AlaskaDischarge %>%
  filter(Bin == 4 )%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >=1966 & Year <= 2018)

# find the mean discharge value of each month over time 
AlaskaDischarge_4_mean <- AlaskaDischarge_4_ori.Monthly%>%
  group_by(Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischarge_4_1994 <- data.frame(Year = 1994, Month =c(10,11,12) , Discharge = AlaskaDischarge_4_mean$Discharge[10:12])
AlaskaDischarge_4_1995 <- data.frame(Year = 1995, Month =c(1,2,3,4,5,6,7,8,9,10,11,12) , Discharge = AlaskaDischarge_4_mean$Discharge[1:12])
AlaskaDischarge_4_1996 <- data.frame(Year = 1996, Month =c(1,2,3,4,5,6,7,8,9) , Discharge = AlaskaDischarge_4_mean$Discharge[1:9])

AlaskaDischarge_4_add <- rbind(AlaskaDischarge_4_1994, AlaskaDischarge_4_1995, AlaskaDischarge_4_1996)

# combine original data with added data
AlaskaDischarge_4.Monthly <-rbind(data.frame(AlaskaDischarge_4_ori.Monthly), data.frame(AlaskaDischarge_4_add))

# arrange new added data in Year and Month range
AlaskaDischarge_4.Monthly <- arrange(AlaskaDischarge_4.Monthly, Year, Month)
  
# Bin 5 
AlaskaDischarge_5.Monthly <- AlaskaDischarge %>%
  filter(Bin ==5)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1954 & Year <= 2018)
  

# Bin 6 
AlaskaDischarge_6_ori.Monthly <- AlaskaDischarge %>%
  filter(Bin ==6)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1952 & Year <= 2018)

AlaskaDischarge_6_mean <- AlaskaDischarge_6_ori.Monthly%>%
  group_by(Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischarge_6_1994 <- data.frame(Year = 1994, Month =c(10,11,12) , Discharge = AlaskaDischarge_6_mean$Discharge[10:12])
AlaskaDischarge_6_1995 <- data.frame(Year = 1995, Month =c(1,2,3,4,5,6,7,8,9) , Discharge = AlaskaDischarge_6_mean$Discharge[1:9])

AlaskaDischarge_6_add <- rbind(AlaskaDischarge_6_1994, AlaskaDischarge_6_1995)

AlaskaDischarge_6.Monthly <-rbind(data.frame(AlaskaDischarge_6_ori.Monthly), data.frame(AlaskaDischarge_6_add))

AlaskaDischarge_6.Monthly <- arrange(AlaskaDischarge_6.Monthly, Year, Month)  

#Bin 7
AlaskaDischarge_7_ori.Monthly <- AlaskaDischarge %>%
  filter(Bin ==7)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1950 & Year <= 2018)

AlaskaDischarge_7_mean <- AlaskaDischarge_7_ori.Monthly%>%
  group_by(Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischarge_7_1966 <- data.frame(Year = 1966, Month =7 , Discharge = AlaskaDischarge_7_mean$Discharge[7])
AlaskaDischarge_7_2006 <- data.frame(Year = 2006, Month =c(7,8,9) , Discharge = AlaskaDischarge_7_mean$Discharge[7:9])
AlaskaDischarge_7_2007 <- data.frame(Year = 2007, Month =12 , Discharge = AlaskaDischarge_7_mean$Discharge[12])
AlaskaDischarge_7_2008 <- data.frame(Year = 2008, Month =6 , Discharge = AlaskaDischarge_7_mean$Discharge[6])
AlaskaDischarge_7_2013 <- data.frame(Year = 2013, Month =8 , Discharge = AlaskaDischarge_7_mean$Discharge[8])

AlaskaDischarge_7_add <- rbind(AlaskaDischarge_7_1966, AlaskaDischarge_7_2006, AlaskaDischarge_7_2007,AlaskaDischarge_7_2008, AlaskaDischarge_7_2013)

AlaskaDischarge_7.Monthly <-rbind(data.frame(AlaskaDischarge_7_ori.Monthly), data.frame(AlaskaDischarge_7_add))

AlaskaDischarge_7.Monthly <- arrange(AlaskaDischarge_7.Monthly, Year, Month)

#Bin 8
AlaskaDischarge_8_ori.Monthly <- AlaskaDischarge %>%
  filter(Bin == 8)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1977 & Year <= 2018)

AlaskaDischarge_8_mean <- AlaskaDischarge_8_ori.Monthly%>%
  group_by(Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischarge_8_1995 <- data.frame(Year = 1995, Month =10 , Discharge = AlaskaDischarge_8_mean$Discharge[10])
AlaskaDischarge_8_1999 <- data.frame(Year = 1999, Month =c(9,10,11,12) , Discharge = AlaskaDischarge_8_mean$Discharge[9:12])
AlaskaDischarge_8_2009 <- data.frame(Year = 2009, Month =c(4,5,7,8) , Discharge =c( AlaskaDischarge_8_mean$Discharge[4:5], AlaskaDischarge_8_mean$Discharge[7:8]))
AlaskaDischarge_8_2016 <- data.frame(Year = 2016, Month =c(8,10,11,12) , Discharge =c( AlaskaDischarge_8_mean$Discharge[8],AlaskaDischarge_8_mean$Discharge[10:12]))
AlaskaDischarge_8_2017 <- data.frame(Year = 2017, Month =c(1,7,8,11) , Discharge = c(AlaskaDischarge_8_mean$Discharge[1],AlaskaDischarge_8_mean$Discharge[7:8],AlaskaDischarge_8_mean$Discharge[11]))

AlaskaDischarge_8_add <- rbind(AlaskaDischarge_8_1995, AlaskaDischarge_8_1999, AlaskaDischarge_8_2009,AlaskaDischarge_8_2016, AlaskaDischarge_8_2017)

AlaskaDischarge_8.Monthly <-rbind(data.frame(AlaskaDischarge_8_ori.Monthly), data.frame(AlaskaDischarge_8_add))

AlaskaDischarge_8.Monthly <- arrange(AlaskaDischarge_8.Monthly, Year, Month)

#Bin 9
AlaskaDischarge_9.Monthly <- AlaskaDischarge %>%
  filter(Bin ==9)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >=1983 & Year <= 2018)
```

```{r Discharge Seasonal Change Analysis}
# run time series
AlaskaDischarge_1_ts.Monthly <- ts(AlaskaDischarge_1.Monthly[[3]], frequency = 12)
AlaskaDischarge_2_ts.Monthly <- ts(AlaskaDischarge_2.Monthly[[3]], frequency = 12)
AlaskaDischarge_3_ts.Monthly <- ts(AlaskaDischarge_3.Monthly[[3]], frequency = 12)
AlaskaDischarge_4_ts.Monthly <- ts(AlaskaDischarge_4.Monthly[[3]], frequency = 12)
AlaskaDischarge_5_ts.Monthly <- ts(AlaskaDischarge_5.Monthly[[3]], frequency = 12)
AlaskaDischarge_6_ts.Monthly <- ts(AlaskaDischarge_6.Monthly[[3]], frequency = 12)
AlaskaDischarge_7_ts.Monthly <- ts(AlaskaDischarge_7.Monthly[[3]], frequency = 12)
AlaskaDischarge_8_ts.Monthly <- ts(AlaskaDischarge_8.Monthly[[3]], frequency = 12)
AlaskaDischarge_9_ts.Monthly <- ts(AlaskaDischarge_9.Monthly[[3]], frequency = 12)

# run smk.test of 9 bins
AlaskaDischarge_1_trend <-smk.test(AlaskaDischarge_1_ts.Monthly) 
AlaskaDischarge_2_trend <-smk.test(AlaskaDischarge_2_ts.Monthly) 
AlaskaDischarge_3_trend <-smk.test(AlaskaDischarge_3_ts.Monthly) 
AlaskaDischarge_4_trend <-smk.test(AlaskaDischarge_4_ts.Monthly) 
AlaskaDischarge_5_trend <-smk.test(AlaskaDischarge_5_ts.Monthly) 
AlaskaDischarge_6_trend <-smk.test(AlaskaDischarge_6_ts.Monthly) 
AlaskaDischarge_7_trend <-smk.test(AlaskaDischarge_7_ts.Monthly) 
AlaskaDischarge_8_trend <-smk.test(AlaskaDischarge_8_ts.Monthly) 
AlaskaDischarge_9_trend <-smk.test(AlaskaDischarge_9_ts.Monthly) 

# find sea.sens.slope of each bin
slope_1 <- sea.sens.slope(AlaskaDischarge_1_ts.Monthly)
slope_2 <- sea.sens.slope(AlaskaDischarge_2_ts.Monthly)
slope_3 <- sea.sens.slope(AlaskaDischarge_3_ts.Monthly)
slope_4 <- sea.sens.slope(AlaskaDischarge_4_ts.Monthly)
slope_5 <- sea.sens.slope(AlaskaDischarge_5_ts.Monthly)
slope_6 <- sea.sens.slope(AlaskaDischarge_6_ts.Monthly)
slope_7 <- sea.sens.slope(AlaskaDischarge_7_ts.Monthly)
slope_8 <- sea.sens.slope(AlaskaDischarge_8_ts.Monthly)
slope_9 <- sea.sens.slope(AlaskaDischarge_9_ts.Monthly)
```

```{r Discharge Seasonal Change Analysis}
## create the dataframe of bin and correlated sens.slope
Discharge_Trend <- data.frame(Bin = c(1,2,3,4,5,6,7,8,9),Slope = c(slope_1,slope_2,slope_3,slope_4,slope_5,slope_6,slope_7,slope_8,slope_9), Trend = c(AlaskaDischarge_1_trend$p.value, AlaskaDischarge_2_trend$p.value,AlaskaDischarge_3_trend$p.value,AlaskaDischarge_4_trend$p.value,AlaskaDischarge_5_trend$p.value,AlaskaDischarge_6_trend$p.value, AlaskaDischarge_7_trend$p.value, AlaskaDischarge_8_trend$p.value, AlaskaDischarge_9_trend$p.value))

# mean discharge
AlaskaDischarge_mean <- AlaskaDischarge %>%
  group_by(Bin)%>%
  drop_na()%>%
  summarise(meanDischarge = mean(Discharge))

AlaskaDischarge_mean$Bin <- as.factor(AlaskaDischarge_mean$Bin)
Discharge_Trend$Bin <- as.factor(Discharge_Trend$Bin)

Discharge_Trend <- left_join(AlaskaDischarge_mean, Discharge_Trend, by = 'Bin')

Discharge_Trend <- Discharge_Trend%>%
  mutate(meanSlope = Slope/meanDischarge)

# if the p.value < 0.05, keep the original sens.slope, otherwise replace it with NA
for (i in 1:9){
  if (Discharge_Trend$Trend[i] > 0.05){
    Discharge_Trend$meanSlope[i] <- NA
  } else {
    Discharge_Trend$meanSlope[i] <- Discharge_Trend$meanSlope[i]
  }
}

# write csv file
Discharge_Change <- Discharge_Trend[c(1,5)]
names(Discharge_Change)[2]<-'Slope'
write.csv(Discharge_Change, "./DATA/PROCESSED/Discharge_Change_new.csv",
          row.names = F)
```

# Graph of normalized sens.slope of discharge of each bin
```{r Discharge Seasonal Change Analysis}
# This graph shows the sens.slope of each bin 
Discharge_change.plot<- ggplot(Discharge_Change, aes(x = Bin, y = Slope))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  labs(x = 'Bin', y = 'Sens.slope of Discharge')+
  theme(text = element_text(size=18))
print(Discharge_change.plot)
```


## Question 1: <insert specific question here and add additional subsections for additional questions below>

## Question 2: 


The Climate Science Special Report estimates that maximum temperature increases in Alaska since between the first half of the 20th century and the past 30 years have been 1.43 degrees F (https://science2017.globalchange.gov/chapter/6/).

\newpage

# Summary and Conclusions
<Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.>

One possible reason for such little impact of temperature on the date of peak snowmelt is the months in which temperature trends occur. For example, though the overall temperature for Bin 5 shows an increasing trend, the spring months of March, April, and May actually show a cooling trends. Summer and fall months however show increasing temperature trends that outweigh the cooling trends of earlier months. As the sen's slope is the median of all monthly trends, this nuance is not exhibited in the overall temperature trend. Warmer summer and fall seasons may have little impact on the date of peak discharge.

The analyses in this study do not strongly support the hypotheses. The overall temperature trends do not show polar amplification, in part due to a small number of latitude bins and only one temperature site per bin. Similarly, there is no statistically significant relationship between change in discharge over time and latitude. There were only five sites that had both statistically significant trends in temperature and discharge, and these five sites did not show a relationship between temperature and discharge or temperature and day of peak discharge.

Future analsyses should take a more nuanced approach to investigating the impacts of climate change on discharge of Alaskan streams. Temperature data show a need to investigate the seasons that will have direct effects on stream discharge rather than looking at the year as a whole.


\newpage

# References
<add references here> 

“Climate Impacts in Alaska.” EPA, Environmental Protection Agency, 13 Jan. 2017, 19january2017snapshot.epa.gov/climate-impacts/climate-impacts-alaska_.html#Reference%203.

Earth System Research Laboratory. Barrow's Annual Snow Cycle; Ecological Responses to a Lengthening Snow-free Season. (2017). Retrieved from https://www.esrl.noaa.gov/gmd/grad/snomelt.html.

Easterling, D.R., K.E. Kunkel, J.R. Arnold, T. Knutson, A.N. LeGrande, L.R. Leung, R.S. Vose, D.E. Waliser, and M.F. Wehner, 2017: Precipitation change in the United States. In: Climate Science Special Report: Fourth National Climate Assessment, Volume I [Wuebbles, D.J., D.W. Fahey, K.A. Hibbard, D.J. Dokken, B.C. Stewart, and T.K. Maycock (eds.)]. U.S. Global Change Research Program, Washington, DC, USA, pp. 207-230, doi: 10.7930/J0H993CC.

Kashiwase, H., Ohshima, K. I., Nihashi, S., & Eicken, H. (2017). Evidence for ice-ocean albedo feedback in the Arctic Ocean shifting to a seasonal ice zone. Scientific reports, 7(1), 8170.

Serreze, M. C., Barrett, A. P., Stroeve, J. C., Kindig, D. N., and Holland, M. M.: The emergence of surface-based Arctic amplification, The Cryosphere, 3, 11–19, https://doi.org/10.5194/tc-3-11-2009, 2009.

U.S. Geologic Survey. Snowmelt Runoff and the Water Cycle. Retrieved from https://www.usgs.gov/special-topic/water-science-school/science/snowmelt-runoff-and-water-cycle?qt-science_center_objects=0#qt-science_center_objects.

Walsh, J. et al., 2014: Ch. 2: Our Changing Climate. J.M. Melillo, T. (T. C.. Richmond, and G.W. Yohe, Eds., U.S. Global Change Research Program, 19–67.
