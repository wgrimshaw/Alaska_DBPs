---
title: "Discharge_Analysis"
author: "Yixin Wen"
date: "11/11/2019"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=FALSE}
getwd()

library(tidyverse)
library(lubridate)
library(dataRetrieval)
library(trend)
library(forecast)
library(tseries)
library(zoo)
theme_set(theme_classic())
```


```{r,echo = FALSE}
# import data
AlaskaTempPrecipDischarge <- read_csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")
# transform bin into factor
AlaskaTempPrecipDischarge$Bin <- as.factor(AlaskaTempPrecipDischarge$Bin)

AlaskaTempPrecipDischarge$DATE <- as.Date(AlaskaTempPrecipDischarge$DATE,
                                          format = "%Y-%m-%d")
#Extract date and discharge data
AlaskaDischarge <- AlaskaTempPrecipDischarge%>%
  select("DATE", "Bin","STATION","NAME", "site_no", "Discharge")
#drop na
AlaskaDischarge<-AlaskaDischarge%>%drop_na()

# plot discharge  over time for 10 latitude bins
discharge_plot <- ggplot(AlaskaDischarge,aes(x = DATE, y = Discharge))+
  geom_line()+ # add a representative line
  facet_wrap(~Bin, nrow = 3, ncol = 3)+
  labs(x = "Date", y =expression("Discharge (ft"^3*"/s)"))
print(discharge_plot)
  
```

```{r}
Alaska_Discharge_Monthly <- AlaskaDischarge %>%
  mutate(Year = year(DATE), Month = month(DATE)) %>%
  group_by(Year, Month, Bin) %>%
  summarize(Discharge = mean(Discharge)) %>%
  mutate(Date = as.yearmon(paste(Year, Month), "%Y %m"))%>%
  drop_na()

Discharge_Change <- rep(0, 9)

Site_bin <- 9

## Where for loop will start

for(i in 1:9){
  
  ## Step 1: filter data by site
  Alaska_Discharge_Monthly_Site <- Alaska_Discharge_Monthly %>%
    filter(Bin == Site_bin) %>%
  ## Step 2: Remove incomplete years if first or last year
    ## interpolate values if missing months internally
    group_by(Year) %>%
    add_count(Year) %>%
    filter(n == 12)
  
  ## Use only latest data points when there are large gaps in the data record
  ## identified through examination
  ## would like better way to handle smaller gaps in bins 3, 4, 6, 7
  if(Site_bin == 2){
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1990)
  } else if(Site_bin == 3) {
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1985)
  } else if(Site_bin == 4) {
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1995)
  } else if(Site_bin == 6) {
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1995)
  } else if(Site_bin == 7) {
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site)
  } else if(Site_bin == 8) {
    Alaska_Discharge_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year < 2018)
  } 
  
  ## number of data points for interpolation
  n_months = 12 * (max(Alaska_Discharge_Monthly_Site$Year) -
                     min(Alaska_Discharge_Monthly_Site$Year) + 1)
  
  Alaska_Discharge_Monthly_Interp <- Alaska_Discharge_Monthly_Site %>%
    ungroup() %>%
    select(Date,Discharge )
  
  ## Interpolate using neighboring months, will return original data frame if complete
  Alaska_Discharge_Monthly_Interp <- as.data.frame(approx(Alaska_Discharge_Monthly_Interp,
                                                   n = n_months,
                                                   method = "linear")) %>%
    rename(Date = x, Discharge = y)
  
  ## create time series object from interpolated temp data
  Alaska_Discharge_Monthly_ts <- ts(Alaska_Discharge_Monthly_Interp[[2]], frequency = 12)
    
  ## SMK Test for trend
  Alaska_Monthly_Trend <- smk.test(Alaska_Discharge_Monthly_ts)
  
  ## if significant trend, add slope to slope vector
  ## else add 0 to slope vector
  if (Alaska_Monthly_Trend$p.value > 0.05){
    Discharge_Change[Site_bin] <- NA
  } else {
    Slope <- sea.sens.slope(Alaska_Discharge_Monthly_ts)
    Discharge_Change[Site_bin] <- Slope
  }
}
Bin <- seq(1,9)
Sens_Slope_Discharge <- as.data.frame(cbind(Bin, Discharge_Change))
write.csv(Sens_Slope_Discharge, "./Data/PROCESSED/Discharge_Change.csv")
```


```{r}
# plot bin 2-9 to see if there's an obvious gap in original dataset
AlaskaDischarge_7 <- AlaskaDischarge %>%
  filter(Bin == 7)%>%
  drop_na()

discharge_7_plot <-ggplot(AlaskaDischarge_7, aes(x = DATE, y = Discharge))+
  geom_line()
print(discharge_7_plot)
```

for bin 2, choose dataset from time 1995, for bin 3 choose dataset from 1948, for bin 4, use linear interplotation to fill the missing data from 1994-10 to 1996-10
```{r}
# bin 2: choose >1995
# bin 3: choose>1949
# bin 4: missing 1994-10 to 1996-10 

#Bin 1
AlaskaDischarge_1.Monthly <- AlaskaDischarge %>%
  filter(Bin ==1)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

#Bin 2
AlaskaDischarge_2.Monthly <- AlaskaDischarge %>%
  filter(Bin == 2)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >= 1995)%>%
  drop_na()
    
#Bin 3
AlaskaDischarge_3.Monthly <- AlaskaDischarge %>%
  filter(Bin == 3 )%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  filter(Year >=1949)%>%
  drop_na()

#Bin 4
AlaskaDischarge_4 <- AlaskaDischarge%>%
  filter(Bin == 4)%>%
  drop_na()

linearinterpolation_4 <- as.data.frame(approx(AlaskaDischarge_4$Discharge,n = 631, method = "linear"))

linearinterpolation_4$x <- as.Date(linearinterpolation_4$x, origin = "1965-05-05")
names(linearinterpolation_4) <-c("Date", "Discharge")


 # the end date is 2017, how to fix that?

AlaskaDischarge_4.Monthly <- linearinterpolation_4%>%
  mutate(Year = year(Date), Month = month(Date))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

# Bin 5 
AlaskaDischarge_5.Monthly <- AlaskaDischarge %>%
  filter(Bin ==5)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

# Bin 6 
AlaskaDischarge_6.Monthly <- AlaskaDischarge %>%
  filter(Bin ==6)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

#Bin 7
AlaskaDischarge_7.Monthly <- AlaskaDischarge %>%
  filter(Bin ==7)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

#Bin 8
AlaskaDischarge_8.Monthly <- AlaskaDischarge %>%
  filter(Bin ==8)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()

#Bin 9
AlaskaDischarge_9.Monthly <- AlaskaDischarge %>%
  filter(Bin ==9)%>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  drop_na()


```

```{r}
# run time series
AlaskaDischarge_1_ts.Monthly <- ts(AlaskaDischarge_1.Monthly[[3]], frequency = 12)
AlaskaDischarge_2_ts.Monthly <- ts(AlaskaDischarge_2.Monthly[[3]], frequency = 12)
AlaskaDischarge_3_ts.Monthly <- ts(AlaskaDischarge_3.Monthly[[3]], frequency = 12)
AlaskaDischarge_4_ts.Monthly <- ts(AlaskaDischarge_4.Monthly[[3]], frequency = 12)
AlaskaDischarge_5_ts.Monthly <- ts(AlaskaDischarge_5.Monthly[[3]], frequency = 12)
AlaskaDischarge_6_ts.Monthly <- ts(AlaskaDischarge_6.Monthly[[3]], frequency = 12)
AlaskaDischarge_7_ts.Monthly <- ts(AlaskaDischarge_7.Monthly[[3]], frequency = 12)
AlaskaDischarge_8_ts.Monthly <- ts(AlaskaDischarge_8.Monthly[[3]], frequency = 12)
AlaskaDischarge_9_ts.Monthly <- ts(AlaskaDischarge_9.Monthly[[3]], frequency = 12)
```

```{r}
# run smk.test
#Bin 1 p = 0.09799
AlaskaDischarge_1_trend.Monthly <-smk.test(AlaskaDischarge_1_ts.Monthly) 
AlaskaDischarge_1_trend.Monthly

#Bin 2 p = 0.00178
AlaskaDischarge_2_trend.Monthly <-smk.test(AlaskaDischarge_2_ts.Monthly) 
AlaskaDischarge_2_trend.Monthly

#Bin 3 p = 0.1952
AlaskaDischarge_3_trend.Monthly <-smk.test(AlaskaDischarge_3_ts.Monthly) 
AlaskaDischarge_3_trend.Monthly

#Bin 4 p = 0.4855
AlaskaDischarge_4_trend.Monthly <-smk.test(AlaskaDischarge_4_ts.Monthly) 
AlaskaDischarge_4_trend.Monthly

#Bin 5 p = 4.604e-14
AlaskaDischarge_5_trend.Monthly <-smk.test(AlaskaDischarge_5_ts.Monthly) 
AlaskaDischarge_5_trend.Monthly

#Bin 6 p =0.0001581
AlaskaDischarge_6_trend.Monthly <-smk.test(AlaskaDischarge_6_ts.Monthly) 
AlaskaDischarge_6_trend.Monthly

#Bin 7 p =0.7437
AlaskaDischarge_7_trend.Monthly <-smk.test(AlaskaDischarge_7_ts.Monthly) 
AlaskaDischarge_7_trend.Monthly

#Bin 8 p =0.3637
AlaskaDischarge_8_trend.Monthly <-smk.test(AlaskaDischarge_8_ts.Monthly) 
AlaskaDischarge_8_trend.Monthly

#Bin 9 p =2.2e-16
AlaskaDischarge_9_trend.Monthly <-smk.test(AlaskaDischarge_9_ts.Monthly) 
AlaskaDischarge_9_trend.Monthly
```


```{r}
# run sea.sens.slope
sea.sens.slope(AlaskaDischarge_1_ts.Monthly)
sea.sens.slope(AlaskaDischarge_2_ts.Monthly)
sea.sens.slope(AlaskaDischarge_3_ts.Monthly)
sea.sens.slope(AlaskaDischarge_4_ts.Monthly)
sea.sens.slope(AlaskaDischarge_5_ts.Monthly)
sea.sens.slope(AlaskaDischarge_6_ts.Monthly)
sea.sens.slope(AlaskaDischarge_7_ts.Monthly)
sea.sens.slope(AlaskaDischarge_8_ts.Monthly)
sea.sens.slope(AlaskaDischarge_9_ts.Monthly)
```


```{r}
AlaskaDischagre_9.Monthly <- AlaskaDischarge_9 %>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischagre_9_ts.Monthly <- ts(AlaskaDischagre_9.Monthly[[3]], frequency = 12)

AlaskaDischagre_9_trend.Monthly <-smk.test(AlaskaDischagre_9_ts.Monthly) 
AlaskaDischagre_9_trend.Monthly
summary(AlaskaDischagre_9_trend.Monthly)

sea.sens.slope(AlaskaDischagre_9_ts.Monthly)
```
bin 1: 0.01
bin 2: 0.01
bin 3: 0.01
bin 4: 0.01
bin 5: 0.01
bin 6: 0.01
bin 7: 0.01
bin 8: 0.01
bin 9: 0.01

```{r}
# add linear interplotation data for missing month for each bin
AlaskaDischarge_6 <- AlaskaDischarge %>%
  filter(Bin == 6)%>%
  drop_na()

AlaskaDischagre_6.Monthly <- AlaskaDischarge_6 %>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))%>%
  add_count(Year)
```

# bin 6
```{r}
# choose bin 6 as an example
AlaskaDischarge_6 <- AlaskaDischarge %>%
  filter(Bin == 6)%>%
  drop_na()

# dataset decomposition
AlaskaDischarge_6_ts <- ts(AlaskaDischarge_6[[6]], frequency = 365)

# Generate the decomposition
AlaskaDischarge6_Decomposed <- stl(AlaskaDischarge_6_ts, s.window = "periodic")
plot(AlaskaDischarge6_Decomposed)
```

```{r}
# extract the components 
AlaskaDischarge6_components <- as.data.frame(AlaskaDischarge6_Decomposed$time.series)
AlaskaDischarge6_components <- mutate (AlaskaDischarge6_components,Observed = AlaskaDischarge_6$Discharge, Date = AlaskaDischarge_6$DATE)

# visualize the trend map onto the data
ggplot(AlaskaDischarge6_components) +
geom_line(aes(y = Observed, x = Date), size = 0.25) + geom_line(aes(y = trend, x = Date), color = "#c13d75ff") + geom_hline(yintercept = 0, lty = 2) + ylab(expression("Discharge (ft"^3*"/s)"))+
  labs(title = "Bin 6")
```

```{r}
## 1st way to do the monthly time series
# Generate monthly values from June 1951 to October 2019
# use linear interpolation
linearinterpolation <- as.data.frame(approx(AlaskaDischarge_6$Discharge,n = 820, method = "linear"))# don't know why the data ends at 2018/09, it should be ended at 2019/10
linearinterpolation$x <- as.Date(linearinterpolation$x, origin = "1951-06-15")
names(linearinterpolation) <-c("Date", "Discharge")

# Generate time series smk.test
Discharge6_ts <- ts(linearinterpolation$Discharge, frequency = 12, start = c(1951,6,15), end = c(2018, 9, 19)) 

# Run SMK test
Discharge6_trend <- smk.test(Discharge6_ts)
Discharge6_trend
summary(Discharge6_trend)

# Bin 6 has significant seasonal variance over the period
```


```{r}
## 2nd way to do the time series
# find the monthly change of Bin 6 over time

AlaskaDischagre_6.Monthly <- AlaskaDischarge_6 %>%
  mutate(Year = year(DATE), Month = month(DATE))%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))

AlaskaDischagre_6.Monthly<-AlaskaDischagre_6.Monthly%>%
  group_by(Year, Month)%>%
  summarise(Discharge = mean(Discharge))
  
AlaskaDischagre_6_ts.Monthly <- ts(AlaskaDischagre_6.Monthly[[3]], frequency = 12)

AlaskaDischagre_6_trend.Monthly <-smk.test(AlaskaDischagre_6_ts.Monthly) 
AlaskaDischagre_6_trend.Monthly
summary(AlaskaDischagre_6_trend.Monthly)

adf.test(AlaskaDischagre_6_ts.Monthly, alternative = "stationary")
# since the p-value is 0.01 < 0.05, the data is stationary
```

```{r}
#run the arima function and search for best fit
auto.arima(AlaskaDischagre_6_ts.Monthly, trace = TRUE)
```

```{r}
# create an object that defines the best fit model
fit <- arima(AlaskaDischagre_6_ts.Monthly, c(1, 0, 0),seasonal = list(order = c(1, 1, 0), period = 12)) 

# make a prediction into the future
AlaskaDischagre_6_prediction <- predict(fit, n.ahead = 10*12)

# plot future predictions
ts.plot(AlaskaDischagre_6_ts.Monthly, AlaskaDischagre_6_prediction$pred, lty = c(1, 3))
```

2 graphs per person. Choose 6 first

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
