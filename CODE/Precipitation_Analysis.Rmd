---
title: "Precipitation_Analysis"
author: "Gaby Garcia"
date: "11/11/2019"
output: pdf_document
---
# Load in Complete Cleaned Dataset
```{r, message=FALSE, warning=FALSE}

setwd("/Users/gabrielagarcia/Desktop/Hydrologic Data Analysis/Hydrologic_Data_Analysis/Course_Project/Alaska/DATA/PROCESSED")
AlaskaTempPrecipDischarge<-read.csv("AlaskaTempPrecipDischarge.csv")
```


### Create Precip only Dataframe with Bins
```{r, message=FALSE, warning=FALSE}
library(dplyr)
AlaskaPrecipOnly<-select(AlaskaTempPrecipDischarge, .data$DATE, .data$PRCP, .data$Bin)
```

### Check number of Precipitation NA's and remove them
```{r}
newdata<-na.omit(AlaskaPrecipOnly)
```

### Ensure Date is a date object and not a factor
```{r}
newdata$DATE<-as.Date(newdata$DATE)
```

### Ensure Bin is a factor and not an integer
```{r}
newdata$Bin <- as.factor(newdata$Bin)
```

# Subset the Data by Bin
```{r}
library(plyr)


Bin1Precip<-filter(newdata, Bin== 1)
Bin2Precip<-filter(newdata, Bin== 2)
Bin3Precip<-filter(newdata, Bin == 3)
Bin4Precip<-filter(newdata, Bin == 4)
Bin5Precip<-filter(newdata, Bin == 5)
Bin6Precip<-filter(newdata, Bin == 6)
Bin7Precip<-filter(newdata, Bin == 7)
Bin8Precip<-filter(newdata, Bin == 8)
Bin9Precip<-filter(newdata, Bin == 9)


```


### Set Personal Theme
```{r}
library(ggplot2)
gabytheme <- theme_bw(base_size = 22) + 
  theme(plot.title=element_text(face="bold", size="26", color="IndianRed3", hjust=0.5),
        axis.title=element_text(size=22, color="black"),
axis.text = element_text(face="bold", size=16, color = "black"), 
panel.background=element_rect(fill="white", color="darkblue"), 
panel.border = element_rect(color = "black", size = 2),
legend.position = "top", legend.background = element_rect(fill="white", color="black"),
            legend.key = element_rect(fill="transparent", color="NA"))

theme_set(gabytheme)
```



# Plot Bin 1 Precip
```{r, fig.width=9, fig.height=3}
library(scales)
library(ggplot2)
Bin1PrecipPlot<- 
  ggplot(Bin1Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%Y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin1PrecipPlot)

```

# Plot Bin 2 Precip over Time
```{r, fig.width=12}
library(scales)
library(ggplot2)
Bin2PrecipPlot<- 
  ggplot(Bin2Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin2PrecipPlot)
```
>There is a gap in precipitation data collection for Bin 2 from 1986-12-31 to 1995-10-01

# Plot Bin 3 Precip over Time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin3PrecipPlot<- 
  ggplot(Bin3Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin3PrecipPlot)

```
>Much higher range in precip values-->more rain and snowfall?

# Plot Bin 4 Precip over Time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin4PrecipPlot<- 
  ggplot(Bin4Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin4PrecipPlot)

```

# Plot Bin 5 Precip over Time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin5PrecipPlot<- 
  ggplot(Bin5Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin5PrecipPlot)

```

# Plot Bin 6 Precip over Time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin6PrecipPlot<- 
  ggplot(Bin6Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin6PrecipPlot)

```


# Plot Bin 7 Precip over time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin7PrecipPlot<- 
  ggplot(Bin7Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin7PrecipPlot)
```


# Plot Bin 8 Precip over time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin8PrecipPlot<- 
  ggplot(Bin8Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin8PrecipPlot)
```

# Plot Bin 9 Precip over time
```{r, fig.width=17}
library(scales)
library(ggplot2)
Bin9PrecipPlot<- 
  ggplot(Bin9Precip, aes(x = DATE, y = PRCP)) +
  geom_line() +
  ggtitle("Alaska Precipitation over Time") +
  labs(x = "", y = expression("Precipitation (in"^3*"/s)"))+
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("1 year"))+
  gabytheme
print(Bin9PrecipPlot)
```
>A lot less precip at highest latitude 

# Attempt a Precip Line Graph but with geom_smooth
```{r, fig.width=13, warning=FALSE, message=FALSE}
PrecipLinePlot<-ggplot(newdata, aes(x = DATE, y = PRCP, color = Bin))  +
  geom_smooth() +
labs(title="Precipitation Measured over Time", x="Sample Year",
       y="Precipitation (inches ^3)")+ 
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("5 years"))+
  gabytheme
print(PrecipLinePlot)
```

## Scatterplot of Full Precipitation Period of Record Colored by Bin
```{r, fig.width=10, fig.height=6}
PrecipBoxplot<-ggplot(newdata, aes(x = DATE, y = PRCP, color = Bin))  +
  geom_point(alpha=0.5, size=2) +
labs(title="Precipitation Measured over Time", x="Sample Year",
       y="Precipitation (inches)")+ 
  scale_x_date(labels=date_format("%y"),
               breaks=date_breaks("5 years"))+
  theme(legend.position="top",
        legend.key.width=unit(1.5, "cm"))+
  gabytheme
print(PrecipBoxplot)
```


## Add Day of Year Column to complete dataframe
```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(lubridate)
newdata <-mutate(newdata, DOY = yday(DATE), Year=year(DATE), Month=month(DATE))
```



```{r}
library(dplyr)
library(plyr)

data.spring.median <- data.spring %>% group_by(Bin, DOY) %>%
  mutate(Dis.Med = median(Discharge))

dis.doy.med <- ggplot(data.spring.median) +
  geom_line(aes(x = DOY, y = Dis.Med, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Median Discharge") +
  scale_color_viridis_d() +
  theme(legend.position = "top")
print(dis.doy.med)
```












##Plot the Median Precipitation by Bin 
```{r, fig.width=5}
library(viridis)

PrecipMedianPlot<- ggplot(newdata) +
  geom_line(aes(x = DOY, y = PrecipMedian, color = as.factor(Bin))) +
  labs(x = "Day of Year", y = "Median Precipitation") +
  scale_colour_manual(values=c('#DC143C', '#00CED1','#BA55D3',	'#D2691E', '#32CD32'))+
  theme(legend.position = "top")+
    theme(legend.key.size = unit(1, "cm"))+
  labs(color="Bin")

print(PrecipMedianPlot)

```
























# Run a Mann-Kendall test for each Bin
>A Mann-Kendall test will analyze whether there is a monotonic trend in the response variable over time. 

## Mann Kendall for Bin 1
```{r}
library(trend)
Bin1Precip$PRCP<-as.numeric(Bin1Precip$PRCP)
mk.test(Bin1Precip$PRCP)
```
>We see a negative trend in precipitation over time. z is the direction and magnitude of the trend. p=0.203 so we reject the null hypothesis


### Pettitt's Test
Pettitt's test is also included in the `trend` package. This nonparametric test will determine whether there is a shift in the central tendency of the time series and will tell us at what point the changepoint occurs (if it detects one). Note: Pettitt's Test will only test for one changepoint, and further tests must be run if multiple change points are suspected.

```{r}
# Test for change point
pettitt.test(Bin1Precip$PRCP)

```
>Is our p-value <0.05? IF SO THEN OUR CHANGE POINT IS SIGNIFICANT. 
It is 0.029, so we'll have to go into our data set and look at where change point happened
change point is 910, so scroll down to place 910 in data set. It happened in 1970-04-28. 


## Run separate Mann-Kendall for each change point
```{r}
mk.test(Bin1Precip$PRCP[1:909])
mk.test(Bin1Precip$PRCP[910:2492])

```

## Is there a second change point?
```{r}
pettitt.test(Bin1Precip$PRCP[910:2492])  
```
>910+858=1768, so look at 1768 row in datatable to see second change point. 1972-09-02

### Check to see if Second Change Point is significant
```{r}
mk.test(Bin1Precip$PRCP[910:1767])   
mk.test(Bin1Precip$PRCP[1768:2492])
```


# Seasonal Mann Kendall for Bin 1 Precip

## Create a time series object
```{r}
Bin1TimeSeries<- ts(Bin1Precip$PRCP, 
                                frequency = 365)
```

### Decomposition
```{r}
Bin1Decomposed <- stl(Bin1TimeSeries, s.window = "periodic")
plot(Bin1Decomposed)
```

## Perform Seasonal Mann Kendall Test
```{r}
Bin1SeasonalTrend <- smk.test(Bin1TimeSeries)

summary(Bin1SeasonalTrend)
```


# Calculate the cumulative annual precip for each year by site and then multiply by drainage area (in NWIS_SiteInfo.csv under raw data) to get a volume of water for each year? We can compare with some cumulative discharge. 

# Calculate Cumulative Annual Precipitation for each year by Site and Create Dataframe
```{r}
CumAnnualPrecip<- AlaskaTempPrecipDischarge%>%
  mutate(Year = year(DATE)) %>%
  group_by(site_no, Year)%>%
  summarize(CumPrecip=sum(PRCP, na.rm=TRUE))
         
```

### Load in NWIS_SiteInfo.csv which has Drainage Areas for each Station
```{r}
NWIS_SiteInfo<- read.csv("../DATA/RAW/NWIS_SiteInfo.csv")
```

## Join NWIS_SiteInfo and CumAnnual Precip by Site Number and multiplt cumulative precip for each station and year by drainage area to determine water volume for each year and station
```{r}
PrecipVolume<-CumAnnualPrecip%>%
  merge(NWIS_SiteInfo, by='site_no')%>%
  mutate(Water_Volume=CumPrecip*drain_area_va)%>%
  select(site_no:dec_long_va, drain_area_va, Water_Volume )
```




