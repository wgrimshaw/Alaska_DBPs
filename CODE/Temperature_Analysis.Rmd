---
title: "Temperature Analysis"
author: "Walker Grimshaw"
date: "11/9/2019"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## install packages and read data
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(tseries)
library(zoo)
Alaska_Data <- read.csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")
theme_set(theme_bw())
```

```{r}
## OLD CODE NOT NEEDED
## add rolling mean temperature column
Alaska_Data <- mutate(Alaska_Data,
                      TMAX_roll = rollmean(TMAX, 60, fill = NA))

## try plotting monthly averages, all look bad
ggplot(Alaska_Temp_Monthly, aes(x = Month, y = aveTMAX, color = Year)) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c() +
  facet_wrap(~Bin, nrow = 3, ncol = 3)

```


```{r}
## Data wrangling
## transform date column from factor to date
Alaska_Data$DATE <- as.Date(Alaska_Data$DATE, format = "%Y-%m-%d")
## Transform Bin column to factor
Alaska_Data$Bin <- as.factor(Alaska_Data$Bin)

## create plot of temperature over time for all 10 latitude bins
ggplot(Alaska_Data, aes(x = DATE, y = TMAX)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~Bin, nrow = 3, ncol = 3) +
  labs(y = "Maximum Daily Temperature (F)", x = "Date")

```

```{r}
## decomposition of temperature series since the trends are so seasonal
## example for bin 5, must remove NAs
Alaska_Data_5 <- Alaska_Data %>%
  filter(Bin == 5 & is.na(TMAX) == FALSE)
## create time series object of temperature
Alaska_Data_5_ts <- ts(Alaska_Data_5[[9]], frequency = 365)

## decomposition
Alaska5_Decomposed <- stl(Alaska_Data_5_ts, s.window = "periodic")
plot(Alaska5_Decomposed)
```

For each latitude bin, the monthly average maximum temperature was calculated. If there were large gaps of multiple years in the period of record, only the more recent data were used. However, if there were shorter data gaps of less than one year in length, linear interpolation was used to estimate the average monthly temperature for any months with missing data. For each latitude bin, a seasonal Mann-Kendall test was performed on the monthly time series to determine if there had been a change in temperature over the period of record. If there had been a change over the period of record, the seasonal sen's slope test was used to determine the average magnitude of the change.

```{r}
## Seasonal Mann-Kendall for whether temperature is changing at each site
## Create monthly dataset for temperature
Alaska_Temp_Monthly <- Alaska_Data %>%
  mutate(Year = year(DATE), Month = month(DATE)) %>%
  group_by(Year, Month, Bin) %>%
  summarize(aveTMAX = mean(TMAX, na.rm = T)) %>%
  mutate(Date = as.yearmon(paste(Year, Month), "%Y %m"))

Temp_Change <- rep(0, 9)

Site_bin <- 9

## Where for loop will start

for(i in 1:9){
  
  ## Step 1: filter data by site
  Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly %>%
    filter(Bin == Site_bin) %>%
  ## Step 2: Remove incomplete years if first or last year
    ## interpolate values if missing months internally
    group_by(Year) %>%
    add_count(Year) %>%
    filter(n == 12)
  
  ## Use only latest data points when there are large gaps in the data record
  ## identified through examination
  ## would like better way to handle smaller gaps in bins 3, 4, 6, 7
  if(Site_bin == 2){
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1990)
  } else if(Site_bin == 3) {
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1985)
  } else if(Site_bin == 4) {
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1995)
  } else if(Site_bin == 6) {
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year > 1995)
  } else if(Site_bin == 7) {
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year < 2006)
  } else if(Site_bin == 8) {
    Alaska_Temp_Monthly_Site <- filter(Alaska_Temp_Monthly_Site, Year < 2018)
  } 
  
  ## number of data points for interpolation
  n_months = 12 * (max(Alaska_Temp_Monthly_Site$Year) -
                     min(Alaska_Temp_Monthly_Site$Year) + 1)
  
  Alaska_Temp_Monthly_Interp <- Alaska_Temp_Monthly_Site %>%
    ungroup() %>%
    select(Date, aveTMAX)
  
  ## Interpolate using neighboring months, will return original data frame if complete
  Alaska_Temp_Monthly_Interp <- as.data.frame(approx(Alaska_Temp_Monthly_Interp,
                                                   n = n_months,
                                                   method = "linear")) %>%
    rename(Date = x, aveTMAX = y)
  
  ## create time series object from interpolated temp data
  Alaska_Temp_Monthly_ts <- ts(Alaska_Temp_Monthly_Interp[[2]], frequency = 12)
    
  ## SMK Test for trend
  Alaska_Monthly_Trend <- smk.test(Alaska_Temp_Monthly_ts)
  
  ## if significant trend, add slope to slope vector
  ## else add 0 to slope vector
  if (Alaska_Monthly_Trend$p.value > 0.05){
    Temp_Change[Site_bin] <- NA
  } else {
    Slope <- sea.sens.slope(Alaska_Temp_Monthly_ts)
    Temp_Change[Site_bin] <- Slope
  }
}
Bin <- seq(1,9)
Sens_Slope_Temp <- as.data.frame(cbind(Bin, Temp_Change))
write.csv(Sens_Slope_Temp, "./Data/PROCESSED/Temperature_Change.csv")

```

