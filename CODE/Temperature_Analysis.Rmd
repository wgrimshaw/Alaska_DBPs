---
title: "Temperature Analysis"
author: "Walker Grimshaw"
date: "11/9/2019"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## install packages and read data
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(tseries)
library(zoo)
Alaska_Data <- read.csv("./DATA/PROCESSED/AlaskaTempPrecipDischarge.csv")
theme_set(theme_bw())
```


```{r}
## OLD CODE NOT NEEDED
## add rolling mean temperature column
Alaska_Data <- mutate(Alaska_Data,
                      TMAX_roll = rollmean(TMAX, 60, fill = NA))

## try plotting monthly averages, all look bad
ggplot(Alaska_Temp_Monthly, aes(x = Month, y = aveTMAX, color = Year)) +
  geom_point(alpha = 0.5) +
  scale_color_viridis_c() +
  facet_wrap(~Bin, nrow = 3, ncol = 3)

```


```{r}
## Data wrangling
## transform date column from factor to date
Alaska_Data$DATE <- as.Date(Alaska_Data$DATE, format = "%Y-%m-%d")
## Transform Bin column to factor
Alaska_Data$Bin <- as.factor(Alaska_Data$Bin)

## create plot of temperature over time for all 10 latitude bins
ggplot(Alaska_Data, aes(x = DATE, y = TMAX)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~Bin, nrow = 3, ncol = 3) +
  labs(y = "Maximum Daily Temperature (F)", x = "Date")

## create  NA rows where there are data gaps so lines don't connect
Bin2NA <- matrix(rep(NA, 13))
names(Bin2NA) <- names(Alaska_Data)
Bin2NA(DATE) = as.Date("1990-01-01", format = "%Y-%m-%d")
  

```

```{r}
## decomposition of temperature series since the trends are so seasonal
## example for bin 5, must remove NAs
Alaska_Data_5 <- Alaska_Data %>%
  filter(Bin == 5 & is.na(TMAX) == FALSE)
## create time series object of temperature
Alaska_Data_5_ts <- ts(Alaska_Data_5[[9]], frequency = 365)

## decomposition
Alaska_Decomposed <- stl(Alaska_Temp_Monthly_ts, s.window = "periodic")
plot(Alaska5_Decomposed)
```

For each latitude bin, the monthly average maximum temperature was calculated. If there were large gaps of multiple years in the period of record, only the more recent data were used. However, if there were shorter data gaps of less than one year in length, linear interpolation was used to estimate the average monthly temperature for any months with missing data. For each latitude bin, a seasonal Mann-Kendall test was performed on the monthly time series to determine if there had been a change in temperature over the period of record. If there had been a change over the period of record, the seasonal sen's slope test was used to determine the average magnitude of the change.

```{r}
## Seasonal Mann-Kendall for whether temperature is changing at each site
## Create monthly dataset for temperature
Alaska_Temp_Monthly <- Alaska_Data %>%
  mutate(Year = year(DATE), Month = month(DATE)) %>%
  group_by(Year, Month, Bin) %>%
  summarize(aveTMAX = mean(TMAX, na.rm = T)) %>%
  mutate(Date = as.yearmon(paste(Year, Month), "%Y %m"))

Temp_Change <- rep(NA, 9)

## Initialize Final Dataframe of monthly data for plotting
Alaska_Temp_Monthly_Model <- data.frame(Date = numeric(),
                                        aveTMAX = numeric(),
                                        Bin = factor())

## Where for loop will start
#Site_bin <- 7

for(Site_bin in 1:9){
  
  ## Step 1: filter data by site
  Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly %>%
    filter(Bin == Site_bin)
  
  ## Use only latest data points when there are large gaps in the data record
  ## identified through examination
  ## would like better way to handle smaller gaps in bins 3, 4, 6, 7
  if(Site_bin == 2){
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > 1995 &
               Year < max(Alaska_Temp_Monthly_Site$Year))
  } else if(Site_bin == 3) {
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > 1945 &
               Year < max(Alaska_Temp_Monthly_Site$Year))
  } else if(Site_bin == 4) {
    missing_years <- c(1995, 1996)
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > min(Alaska_Temp_Monthly_Site$Year)
             & Year < max(Alaska_Temp_Monthly_Site$Year)
             & Year != 1996)
  } else if(Site_bin == 6) {
    missing_years <- c(1995)
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > min(Alaska_Temp_Monthly_Site$Year)
             & Year < max(Alaska_Temp_Monthly_Site$Year)
             & Year != 1995)
  } else if(Site_bin == 7) {
    missing_years <- c(2007)
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > min(Alaska_Temp_Monthly_Site$Year)
             & Year < max(Alaska_Temp_Monthly_Site$Year)
             & Year != 2007)
  }
  
  ## If missing years, fill in annual gaps. if not, skip to interpolating months
  if(Site_bin %in% c(4,6,7)){
      ## Calculate Mean for each month
    Ave_Temp_Site <- Alaska_Temp_Monthly_Site %>%
      group_by(Month) %>%
      summarize(aveTMAX_month = mean(aveTMAX, na.rm = T)) %>%
    ## add columns to match with entire site data
      transmute(Year = NA, Month = Month, Bin = as.factor(Site_bin),
                aveTMAX = aveTMAX_month)
    
    ## create missing dataframe to fill in annual gaps
    ## need to make the length of the number of missing years
    if(Site_bin == 4){
      Alaska_Temp_Missing <- Ave_Temp_Site %>%
        bind_rows(Ave_Temp_Site)
    } else {
      Alaska_Temp_Missing <- Ave_Temp_Site
    }
    Alaska_Temp_Missing <- Alaska_Temp_Missing %>%
      mutate(Year = rep(missing_years, each = 12),
             Date = as.yearmon(paste(Year, Month), "%Y %m"))
        
    ## fill in gaps and arrange by year and month
    Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      bind_rows(Alaska_Temp_Missing) %>%
      arrange(Year, Month)
  } else if(Site_bin %in% c(1,5,8,9)) {
      Alaska_Temp_Monthly_Site <- Alaska_Temp_Monthly_Site %>%
      filter(Year > min(Alaska_Temp_Monthly_Site$Year)
             & Year < max(Alaska_Temp_Monthly_Site$Year))
  }
  
  ## number of data points for interpolation
  n_months = 12 * (max(Alaska_Temp_Monthly_Site$Year) -
                     min(Alaska_Temp_Monthly_Site$Year) + 1)
  
  Alaska_Temp_Monthly_Interp <- Alaska_Temp_Monthly_Site %>%
    ungroup() %>%
    select(Date, aveTMAX)
  
  ## Interpolate missing months, will return original data frame if complete
  Alaska_Temp_Monthly_Interp <- as.data.frame(approx(Alaska_Temp_Monthly_Interp,
                                                   n = n_months,
                                                   method = "linear")) %>%
    rename(Year = x, aveTMAX = y)
  
  ## create time series object from interpolated temp data
  Alaska_Temp_Monthly_ts <- ts(Alaska_Temp_Monthly_Interp[[2]], frequency = 12)
    
  ## SMK Test for trend
  Alaska_Monthly_Trend <- smk.test(Alaska_Temp_Monthly_ts)
  
  ## if significant trend, add slope to slope vector
  ## else add 0 to slope vector
  if (Alaska_Monthly_Trend$p.value > 0.05){
    Temp_Change[Site_bin] <- NA
  } else {
    Slope <- sea.sens.slope(Alaska_Temp_Monthly_ts)
    Temp_Change[Site_bin] <- Slope
  }
  
  ## Add Bin column to interpolated data frame
  Alaska_Temp_Monthly_Interp_Bin <- Alaska_Temp_Monthly_Interp %>%
    mutate(Bin = Site_bin)
  ## rbind Interpolated dataframe to final monthly dataframe for plotting
  Alaska_Temp_Monthly_Model <- rbind(Alaska_Temp_Monthly_Model,
                                     Alaska_Temp_Monthly_Interp_Bin)
}
## coerce Bin column to class factor
Alaska_Temp_Monthly_Model$Bin <- as.factor(Alaska_Temp_Monthly_Model$Bin)

Bin <- seq(1,9)
Sens_Slope_Temp <- as.data.frame(cbind(Bin, Temp_Change))
write.csv(Sens_Slope_Temp, "./Data/PROCESSED/Temperature_Change.csv",
          row.names = F)

```


```{r}
## Interpolate monthly temperatures for internal missing years using monthly averages
ggplot(Alaska_Temp_Monthly_Site, aes(x = Date, y = aveTMAX)) +
  geom_line()
ggplot(Alaska_Temp_Monthly_Interp, aes(x = Year, y = aveTMAX)) +
  geom_line()

```


```{r}
## Final Temp plot, maybe with trend lines
ggplot(Alaska_Temp_Monthly_Model, aes(x = Year, y = aveTMAX)) +
  geom_line(alpha = 0.8) +
  geom_smooth(method = lm) +
  facet_wrap(~Bin, nrow = 3, ncol = 3) +
  labs(y = "Maximum Daily Temperature (F)", x = "Date")

## Plot of Temp change for each bin
ggplot(Sens_Slope_Temp, aes(x = Bin, y = Temp_Change)) +
  geom_point() #+
  #geom_smooth(method = lm, se = FALSE)
```

